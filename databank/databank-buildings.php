<?php
extract(array_flip(H3Effect::operation));
extract(array_flip(H3Effect::context));
extract(array_flip(H3Effect::fortification), EXTR_PREFIX_ALL, 'f');
extract($constants['resources']);
extract(json_decode(file_get_contents("$outPath/townsID.json"), true));
extract(json_decode(file_get_contents("$outPath/creaturesID.json"), true));

$genr = array_column(csvFile($options, 'GENRLTXT.TXT', 0, false), 0);
$shapes = json_decode(file_get_contents($shapesPath), true);

// Procedure for cross-checking building data:
// 1. Diff IDs from buildingsID.json with values in (take all strings' contents
//    and split by space): HeroWO\H3M\ObjectDetails_Town::$builts
// 2. Export buildings.json using obst.php -j -js and run this script:
//
//    $HALL = $BO = $TB = $TZ = $TO = [];
//    $data = json_decode(file_get_contents('obst.json'));
//
//    foreach ($data[0][0] as $building) {
//      foreach (array_merge($building[0]->image, $building[0]->imageU)  as $im) {
//        foreach ($im[0] as $im) {
//          foreach ($im as $im) {
//            $HALL[] = $im->hallImage[0].'-'.$im->hallImage[2];
//            $TB[] = $im->scapeImage;
//            $TO[] = $im->scapeOutline;
//            $TZ[] = 'TZ'.substr($im->scapeOutline, 2);
//            $BO[] = $im->icon;
//          }
//        }
//      }
//    }
//
//    sort($BO);
//    sort($TB);
//    sort($TZ);
//    sort($TO);
//    file_put_contents('BO.txt', join(PHP_EOL, $BO));
//    file_put_contents('TB.txt', join(PHP_EOL, $TB));
//    file_put_contents('TZ.txt', join(PHP_EOL, $TZ));
//    file_put_contents('TO.txt', join(PHP_EOL, $TO));
//
//    $h = array_flip($HALL);
//    foreach (explode(' ', 'HALLCSTL HALLDUNG HALLELEM HALLFORT HALLINFR HALLNECR HALLRAMP HALLSTRN HALLTOWR') as $im) {
//      for ($i = 0; $i < 44; $i++) {
//        if (!isset($h["$im-$i"])) {
//          echo "missing $im-$i", PHP_EOL;
//        } else {
//          unset($h["$im-$i"]);
//        }
//      }
//    }
//    $h = array_filter($h);
//    if ($h) {
//      echo 'extra keys:', PHP_EOL, join(PHP_EOL, array_keys($h));
//    }
//
// 3. Check "extra keys" output by the script.
// 4. Diff list of file names without extensions: DEF/TB* against TB.TXT.
// 5. Diff list of file names without extensions: BMP/BO* against BO.TXT.
// 6. Diff list of file names without extensions: BMP/TO* against TO.TXT.
// 7. Diff list of file names without extensions: BMP/TZ* against TZ.TXT.
// 8. Grep lines $neut/$spec/$dwel/$mine/$minc from this file. Sort and
//    check for duplicate and non-sequential indexes.
//
// SoD archives contain multiple unused images so some differences are expected.

// All BuildingImage properties were determined empirically.
// It's next to impossible to determine correct X/Y up front; the best way is
// to start with 0/0 and then adjust left/bottom in browser's CSS inspector for particular buildings,
// comparing screenshots with those from SoD. After determining correct values
// transfer them to this script.
$image = function ($hallFile, $hallFrame, $scape, $shapeTown, $shapeBuilding,
                   $x, $yFromBottom, $z, $icon = null) use ($shapes) {
  static $backgroundHeight = 374;   // height of TBCSBACK.BMP and others
  $key = 'TZ'.substr($shapeTown, 2).$shapeBuilding; // TOFAIDA -> TZFAIDA
  $shape = $shapes[strtolower($key)];
  $y = $backgroundHeight - $yFromBottom - $shape['height'];

  $ext = $int = [];

  foreach ($shape['polygons'] as $ei => $coords) {
    $ext[] = array_shift($coords);
    $int = array_merge($int, $coords);
  }

  foreach ([&$ext, &$int] as &$ref) {
    foreach ($ref as &$ref2) {
      for ($i = 0; isset($ref2[$i]); $i += 2) {
        $ref2[$i] += $x;
        $ref2[$i + 1] += $y;
      }
    }
  }

  // TOELUP_0 -> BOEUP_0
  $icon = ($shapeTown === 'TOEL' ? 'BOE' : 'BO'.substr($shapeTown, 2)).
          ($icon ?? $shapeBuilding);

  return new BuildingImage([
    'hallImage' => [$hallFile, 0, $hallFrame],
    'scapeImage' => $scape,
    'scapeOutline' => $shapeTown.$shapeBuilding,
    'scapeShapes' => array_map(function ($c) { return join(' ', $c); }, $ext),
    'scapeHoles'  => array_map(function ($c) { return join(' ', $c); }, $int),
    'scapeX' => $x,
    'scapeY' => $y,
    'scapeZ' => $z,
    'icon' => $icon,
  ]);
};

// 'id' keys set below are actually not used outside of this file because
// from1D() overrides them.
$id = 0;

// XXX+I: grl: grail buildings: TOCS/TOF/...+HOLY except: TOFHLYAA TONHOLYA TOSHOLYA TOTHOLYA; icons: BOEGRAIL BOFGRAIL BONHOLYG BOTGRAIL

// XXX=C costs were obtained from the in-game dialog; need to validate against BUILDING.TXT

// Determined empirically.
return [
  'hall' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 10, 'TBCSHALL', 'TOCS', 'H101',  0,   27, 4, 'HAL1'),
      $rampart => $image('HALLRAMP', 10, 'TBRMHALL', 'TOR',  'HAL1', 565, 34, 87),
      $tower   => $image('HALLTOWR', 10, 'TBTWHALL', 'TOT',  'HAL1', 0, 39, 4, 'HALL1'),
      $inferno => $image('HALLINFR', 10, 'TBINHALL', 'TOI',  'HAL1', 0, 110, 0),
      $necropolis => $image('HALLNECR', 10, 'TBNCHALL', 'TON', 'HAL1', 468, 140, 0, 'HALL1'),
      $dungeon => $image('HALLDUNG', 10, 'TBDNHALL', 'TOD', 'HALL1', 0, 76, 0),
      $stronghold => $image('HALLSTRN', 10, 'TBSTHALL', 'TOS', 'HAL1A', 0, 7, 0, 'HALL1'),
      $fortress => $image('HALLFORT', 10, 'TBFRHALL', 'TOF', 'HAL1', 166, 159, 12, 'HALL1'),
      $conflux => $image('HALLELEM', 10, 'TBELHALL', 'TOEL', 'HALL', 0, 15, 16, 'HALL1'),
    ],
    'name' => $neut[10][0],
    'description' => $neut[10][1],
    'effects' => [['income', +500, 'ifPlayer' => true, 'ifResource' => $gold]],
  ],
  'townHall' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 11, 'TBCSHAL2', 'TOCS', 'H201', 0,   27, 4, 'HAL2'),
      $rampart => $image('HALLRAMP', 11, 'TBRMHAL2', 'TOR',  'HAL2', 538, 38, 87),
      $tower   => $image('HALLTOWR', 11, 'TBTWHAL2', 'TOT',  'HAL2', 0, 15, 4, 'HALL2'),
      $inferno => $image('HALLINFR', 11, 'TBINHAL2', 'TOI',  'HAL2', 0, 110, 0),
      $necropolis => $image('HALLNECR', 11, 'TBNCHAL2', 'TON', 'HAL2', 482, 142, 0, 'HALL2'),
      $dungeon => $image('HALLDUNG', 11, 'TBDNHAL2', 'TOD', 'HALL2', 0, 77, 0),
      $stronghold => $image('HALLSTRN', 11, 'TBSTHAL2', 'TOS', 'HAL2A', 0, 7, 0, 'HALL2'),
      $fortress => $image('HALLFORT', 11, 'TBFRHAL2', 'TOF', 'HAL2', 166, 159, 12, 'HALL2'),
      $conflux => $image('HALLELEM', 11, 'TBELHAL2', 'TOEL', 'HAL2', 0, 15, 16, 'HALL2'),
    ],
    'upgrade' => ['hall'],
    'require' => ['hall', 'tavern'],
    'cost_gold' => 2500,
    'name' => $neut[11][0],
    'description' => $neut[11][1],
    'effects' => [['income', +1000, 'ifPlayer' => true, 'ifResource' => $gold]],
  ],
  'cityHall' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 12, 'TBCSHAL3', 'TOCS', 'H301', 0,   27, 4, 'HAL3'),
      $rampart => $image('HALLRAMP', 12, 'TBRMHAL3', 'TOR',  'HAL3', 538, 7,  87),
      $tower   => $image('HALLTOWR', 12, 'TBTWHAL3', 'TOT',  'HAL3', 0, 15, 4, 'HALL3'),
      $inferno => $image('HALLINFR', 12, 'TBINHAL3', 'TOI',  'HAL3', 0, 110, 0),
      $necropolis => $image('HALLNECR', 12, 'TBNCHAL3', 'TON', 'HAL3', 478, 141, 0, 'HALL3'),
      $dungeon => $image('HALLDUNG', 12, 'TBDNHAL3', 'TOD', 'HALL3', 0, 77, 0),
      $stronghold => $image('HALLSTRN', 12, 'TBSTHAL3', 'TOS', 'HAL3A', 0, 7, 0, 'HALL3'),
      $fortress => $image('HALLFORT', 12, 'TBFRHAL3', 'TOF', 'HAL3', 166, 159, 12, 'HALL3'),
      $conflux => $image('HALLELEM', 12, 'TBELHAL3', 'TOEL', 'HAL3', 0, 15, 16, 'HALL3'),
    ],
    'upgrade' => ['townHall'],
    'require' => ['townHall', 'mageGuild1', 'tavern', 'marketplace', 'blacksmith'],
    'cost_gold' => 5000,
    'name' => $neut[12][0],
    'description' => $neut[12][1],
    'effects' => [['income', +2000, 'ifPlayer' => true, 'ifResource' => $gold]],
  ],
  'capitol' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 13, 'TBCSHAL4', 'TOCS', 'H401', 0,   27, 4, 'HAL4'),
      $rampart => $image('HALLRAMP', 13, 'TBRMHAL4', 'TOR',  'HAL4', 534, 7,  87),
      $tower   => $image('HALLTOWR', 13, 'TBTWHAL4', 'TOT',  'HAL4', 0, 15, 4, 'HALL4'),
      $inferno => $image('HALLINFR', 13, 'TBINHAL4', 'TOI',  'HAL4', 0, 111, 0),
      $necropolis => $image('HALLNECR', 13, 'TBNCHAL4', 'TON', 'HAL4', 481, 143, 0, 'HALL4'),
      $dungeon => $image('HALLDUNG', 13, 'TBDNHAL4', 'TOD', 'HALL4', 0, 77, 0),
      $stronghold => $image('HALLSTRN', 13, 'TBSTHAL4', 'TOS', 'HAL4A', 0, 6, 0, 'HALL4'),
      $fortress => $image('HALLFORT', 13, 'TBFRHAL4', 'TOF', 'HAL4', 166, 159, 12, 'HALL4'),
      $conflux => $image('HALLELEM', 13, 'TBELHAL4', 'TOEL', 'HAL4', 0, 15, 16, 'HALL4'),
    ],
    'upgrade' => ['cityHall'],
    'require' => ['cityHall', 'mageGuild1', 'tavern', 'castle', 'marketplace', 'blacksmith'],
    'cost_gold' => 10000,
    'name' => $neut[13][0],
    'description' => $neut[13][1],
    'effects' => [['income', +4000, 'ifPlayer' => true, 'ifResource' => $gold]],
  ],

  'fort' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 7, 'TBCSCSTL', 'TOCS', 'CAS1', 595, 184, 8),
      $rampart => $image('HALLRAMP', 7, 'TBRMCSTL', 'TOR',  'CAS1', 79,  168, 8),
      $tower   => $image('HALLTOWR', 7, 'TBTWCSTL', 'TOT',  'CAS1', 304, 96, 0, 'CAST1'),
      $inferno => $image('HALLINFR', 7, 'TBINCSTL', 'TOI',  'CAS1A', 222, 92, 0, 'CAS1'),
      $necropolis => $image('HALLNECR', 7, 'TBNCCSTL', 'TON', 'CAS1', 138, 112, 1, 'CAST1'),
      $dungeon => $image('HALLDUNG', 7, 'TBDNCSTL', 'TOD', 'CAS1', 363, 123, 2),
      $stronghold => $image('HALLSTRN', 7, 'TBSTCSTL', 'TOS', 'CA1', 402, 149, 0, 'CAS1'),
      $fortress => $image('HALLFORT', 7, 'TBFRCSTL', 'TOF', 'CAS1', 368, 87, 2, 'CAST1'),
      $conflux => $image('HALLELEM', 7, 'TBELCSTL', 'TOEL', 'CSTL', 349, 122, 0, 'CAST1'),
    ],
    'require' => ['hall'],
    'cost_wood' => 20,
    'cost_ore' => 20,
    'cost_gold' => 5000,
    'name' => $neut[7][0],
    'description' => $neut[7][1],
    'effects' => [
      ['fortifications', $a = [$append, $f_gate, $f_upperWall, $f_midUpperWall, $f_midLowerWall, $f_lowerWall], 'ifObject' => true],
      ['fortifications', $a, 'ifVisiting' => true],
      ['fortifications', $a, 'ifGarrisoned' => true],
    ],
  ],
  'citadel' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 8, 'TBCSCAS2', 'TOCS', 'CAS2', 478, 127, 8),
      $rampart => $image('HALLRAMP', 8, 'TBRMCAS2', 'TOR',  'CAS2', 79,  168, 8),
      $tower   => $image('HALLTOWR', 8, 'TBTWCAS2', 'TOT',  'CAS2', 301, 73, 0, 'CAST2'),
      $inferno => $image('HALLINFR', 8, 'TBINCAS2', 'TOI',  'CAS2A', 222, 92, 0, 'CAS2'),
      $necropolis => $image('HALLNECR', 8, 'TBNCCAS2', 'TON', 'CAS2', 139, 112, 1, 'CAST2'),
      $dungeon => $image('HALLDUNG', 8, 'TBDNCAS2', 'TOD', 'CAS2', 363, 43, 2),
      $stronghold => $image('HALLSTRN', 8, 'TBSTCAS2', 'TOS', 'CA2', 402, 150, 0, 'CAS2'),
      $fortress => $image('HALLFORT', 8, 'TBFRCAS2', 'TOF', 'CAS2', 368, 87, 2, 'CAST2'),
      $conflux => $image('HALLELEM', 8, 'TBELCAS2', 'TOEL', 'CAS2', 349, 122, 0, 'CAST2'),
    ],
    'upgrade' => ['fort'],
    'require' => ['fort'],
    'cost_ore' => 5,
    'cost_gold' => 2500,
    'name' => $neut[8][0],
    'description' => $neut[8][1],
    'effects' => [
      ['creature_growth', 1.5, true],
      ['fortifications', $a = [$append, $f_gate2, $f_upperWall2, $f_midUpperWall2, $f_midLowerWall2, $f_lowerWall2, $f_trench2, $f_middleTower2], 'ifObject' => true],
      ['fortifications', $a, 'ifVisiting' => true],
      ['fortifications', $a, 'ifGarrisoned' => true],
    ],
  ],
  'castle' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 9, 'TBCSCAS3', 'TOCS', 'CAS3', 478, 127, 8),
      $rampart => $image('HALLRAMP', 9, 'TBRMCAS3', 'TOR',  'CAS3', 79,  168, 8),
      $tower   => $image('HALLTOWR', 9, 'TBTWCAS3', 'TOT',  'CAS3', 301, 73, 0, 'CAST3'),
      $inferno => $image('HALLINFR', 9, 'TBINCAS3', 'TOI',  'CAS3A', 222, 93, 0, 'CAS3'),
      $necropolis => $image('HALLNECR', 9, 'TBNCCAS3', 'TON', 'CAS3', 34, 105, 1, 'CAST3'),
      $dungeon => $image('HALLDUNG', 9, 'TBDNCAS3', 'TOD', 'CAS3', 363, 43, 2),
      $stronghold => $image('HALLSTRN', 9, 'TBSTCAS3', 'TOS', 'CA3', 402, 150, 0, 'CAS3'),
      $fortress => $image('HALLFORT', 9, 'TBFRCAS3', 'TOF', 'CAS3', 368, 87, 2, 'CAST3'),
      $conflux => $image('HALLELEM', 9, 'TBELCAS3', 'TOEL', 'CAS3', 349, 122, 0, 'CAST3'),
    ],
    'upgrade' => ['citadel'],
    'require' => ['citadel'],
    'cost_wood' => 10,
    'cost_ore' => 10,
    'cost_gold' => 5000,
    'name' => $neut[9][0],
    'description' => $neut[9][1],
    'effects' => [
      ['creature_growth', 2.0, true],
      ['fortifications', $a = [$append, $f_gate3, $f_upperWall3, $f_midUpperWall3, $f_midLowerWall3, $f_lowerWall3, $f_trench3, $f_middleTower3, $f_upperTower3, $f_lowerTower3], 'ifObject' => true],
      ['fortifications', $a, 'ifVisiting' => true],
      ['fortifications', $a, 'ifGarrisoned' => true],
    ],
  ],

  'tavern' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 5, 'TBCSTVRN', 'TOCS', 'TAV1', 0,   0,  12),
      $rampart => $image('HALLRAMP', 5, 'TBRMTVRN', 'TOR',  'TAV',  181, 70, 72),
      $tower   => $image('HALLTOWR', 5, 'TBTWTVRN', 'TOT',  'TAV', 375, 2, 4),
      $inferno => $image('HALLINFR', 5, 'TBINTVRN', 'TOI',  'TAV', 105, 85, 2),
      $necropolis => $image('HALLNECR', 5, 'TBNCTVRN', 'TON', 'TAV', 508, 117, 2),
      $dungeon => $image('HALLDUNG', 5, 'TBDNTVRN', 'TOD', 'TAV', 211, 11, 2),
      $stronghold => $image('HALLSTRN', 5, 'TBSTTVRN', 'TOS', 'TAV', 170, 2, 10, 'TAV1'),
      $fortress => $image('HALLFORT', 5, 'TBFRTVRN', 'TOF', 'TAVA', 634, 29, 12),
      $conflux => $image('HALLELEM', 5, 'TBELTVRN', 'TOEL', 'TVRN', 553, 99, 2, 'TAV'),
    ],
    'cost_wood' => 5,
    'cost_gold' => 500,
    'name' => $neut[5][0],
    'description' => $neut[5][1],
    'effects' => [
      ['creature_morale', +1, true, 'ifContext' => $combat],
      ['creature_morale', +1, 'ifContext' => $combat, 'ifGarrisoned' => true],
      ['creature_morale', +1, 'ifContext' => $combat, 'ifVisiting' => true],
    ],
  ],
  // XXX=B in Castle on-hover is handled by Hall even though Blacksmith overlaps it
  'blacksmith' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 16, 'TBCSBLAK', 'TOCS', 'BLAK', 213, 0,   16),
      $rampart => $image('HALLRAMP', 16, 'TBRMBLAK', 'TOR',  'AID',  558, 180, 85),
      $tower   => $image('HALLTOWR', 16, 'TBTWBLAK', 'TOT',  'BLKA', 478, 17, 0, 'BLACK'),
      $inferno => $image('HALLINFR', 16, 'TBINBLAK', 'TOI',  'BLKA', 684, 1, 2, 'BLAK'),
      $necropolis => $image('HALLNECR', 16, 'TBNCBLAK', 'TON', 'SMITA', 382, 67, 0, 'SMITH'),
      $dungeon => $image('HALLDUNG', 16, 'TBDNBLAK', 'TOD', 'SMITH', 544, 32, 2),
      $stronghold => $image('HALLSTRN', 16, 'TBSTBLAK', 'TOS', 'BLK1', 660, 6, 0, 'BLAK1'),
      $fortress => $image('HALLFORT', 16, 'TBFRBLAK', 'TOF', 'AIDA', 360, 112, 5, 'APOTH'),
      $conflux => $image('HALLELEM', 16, 'TBELBLAK', 'TOEL', 'BLAK', 449, 109, 2, 'BLACK'),
    ],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'name' => $neut[16][0],
    // Taken from the editor.
    'townTypes' => [
      $castle => array_search('ballista', Building::blacksmith),
      $rampart => array_search('firstAidTent', Building::blacksmith),
      $tower => array_search('ammoCart', Building::blacksmith),
      $inferno => array_search('ammoCart', Building::blacksmith),
      $necropolis => array_search('firstAidTent', Building::blacksmith),
      $dungeon => array_search('ballista', Building::blacksmith),
      $stronghold => array_search('ammoCart', Building::blacksmith),
      $fortress => array_search('firstAidTent', Building::blacksmith),
      $conflux => array_search('ballista', Building::blacksmith),
    ],
    'descriptionB' => $neut[19][1],
    'descriptionT' => $neut[20][1],
    'descriptionA' => $neut[21][1],
    'descriptionM' => $neut[28][1],
  ],
  'marketplace' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 14, 'TBCSMARK', 'TOCS', 'MRK1', 413, 0, 20),
      $rampart => $image('HALLRAMP', 14, 'TBRMMARK', 'TOR',  'MRK1', 129, 0, 75),
      $tower   => $image('HALLTOWR', 14, 'TBTWMARK', 'TOT',  'MRK',  614, 9, 0, 'MARK'),
      $inferno => $image('HALLINFR', 14, 'TBINMARK', 'TOI',  'MAR1', 511, 1, 12, 'MRK1'),
      $necropolis => $image('HALLNECR', 14, 'TBNCMARK', 'TON', 'MRK1', 347, 111, 3, 'MARK1'),
      $dungeon => $image('HALLDUNG', 14, 'TBDNMARK', 'TOD', 'MARK', 590, 0, 3, 'MARK1'),
      $stronghold => $image('HALLSTRN', 14, 'TBSTMARK', 'TOS', 'MRK1', 397, 0, 4),
      $fortress => $image('HALLFORT', 14, 'TBFRMARK', 'TOF', 'MRKAA', 382, 39, 7, 'MARK1'),
      $conflux => $image('HALLELEM', 14, 'TBELMARK', 'TOEL', 'MARK', 347, 66, 10),
    ],
    'cost_wood' => 5,
    'cost_gold' => 500,
    'name' => $neut[14][0],
    'description' => $neut[14][1],
  ],
  'shipyard' => [
    'id' => $id++,
    'image' => [
      // XXX all four shapes/outlines NN/NS/MS/MK are identical
      //
      // $z + 1 (25 for $castle: 24 + 1) is reserved for overlaying shipyard outline when a ship is present (TBCSBOAT). See TownBuildingList.Item.
      // If changing $z here, update CSS.
      $castle  => $image('HALLCSTL', 6, 'TBCSDOCK', 'TOCS', 'DKNN', 478, 136, 24, 'DOCK'),
      $necropolis => $image('HALLNECR', 6, 'TBNCDOCK', 'TON', 'SHPNA', 617, 0, 8, 'SHIP'),
      $fortress => $image('HALLFORT', 6, 'TBFRDOCK', 'TOF',  'DCK1', 197, 0, 24, 'SHIP'),
      $conflux => $image('HALLELEM', 6, 'TBELDOCK', 'TOEL',  'DOCK', 239, 110, 8, 'SHIP'),
        // XXX=I hallFrame 20 if with ship, also different outline (TOELBOAT)
    ],
    'town' => [$castle, $necropolis, $fortress, $conflux],
    'cost_wood' => 20,
    'cost_gold' => 2000,
    'name' => $neut[6][0],
    'description' => $neut[6][1],
  ],
  'lighthouse' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 17, 'TBCSSPEC', 'TOCS', 'LT01', 533, 187, 28, 'LITE'),
    ],
    'town' => [$castle],
    'require' => ['shipyard'],
    // Unlike brotherhoodOfSword, etc., lighthouse adds a new building while keeping shipyard. Unlike griffinBastion, etc. that are merely an upgrade, lighthouse is shown on top of shipyard in the hall window and this exception is implemented in CSS.
    //'upgrade' => ['shipyard'],
    'cost_ore' => 10,
    'cost_gold' => 2000,
    'name' => $spec[0][0],
    'description' => $spec[0][1],
    // XXX=C hero_actionPoints
    //
    // XXX=C does this stack? if you have 2 towns with 2 lighthouses
    'effects' => [
      ['hero_actionPoints', +200, 'ifPlayer' => true, 'ifVehicle' => array_search('ship', AObject::vehicle)],
    ],
  ],
  'artifactMerchants' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 17, 'TBTWSPEC', 'TOT',  'MRKA', 674, 13, 10, 'MARKA'),
      $dungeon => $image('HALLDUNG', 17, 'TBDNSPEC', 'TOD',  'ART', 746, 0, 4, 'MARKA'),
      $conflux => $image('HALLELEM', 17, 'TBELSPEC', 'TOEL',  'SPEC', 284, 33, 10, 'MARKA'),
    ],
    'town' => [$tower, $dungeon, $conflux],
    'require' => ['marketplace'],
    'cost_gold' => 10000,
    'name' => $spec[22][0],
    'description' => $spec[22][1],
  ],

  'resourceSiloWO' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 15, 'TBCSSILO', 'TOCS', 'MRK2', 488, 71, 32),
      $necropolis => $image('HALLNECR', 15, 'TBNCSILO', 'TON', 'MRK2', 276, 112, 2, 'MARK2'),
      $stronghold => $image('HALLSTRN', 15, 'TBSTSILO', 'TOS', 'MRK2', 458, 44, 6),
      $fortress => $image('HALLFORT', 15, 'TBFRSILO', 'TOF', 'MRK2A', 448, 116, 6, 'MARK2'),
    ],
    'town' => [$castle, $necropolis, $stronghold, $fortress],
    'require' => ['marketplace'],
    'cost_ore' => 5,
    'cost_gold' => 5000,
    'name' => $spec[10][0],
    'description' => $spec[10][1],
    'effects' => [
      ['income', +1, 'ifPlayer' => true, 'ifResource' => $wood],
      ['income', +1, 'ifPlayer' => true, 'ifResource' => $ore],
    ],
  ],
  'resourceSiloC' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 15, 'TBRMSILO', 'TOR',  'MRK2', 245, 0, 95),
    ],
    'town' => [$rampart],
    'require' => ['marketplace'],
    'cost_ore' => 5,
    'cost_gold' => 5000,
    'name' => $spec[21][0],
    'description' => $spec[21][1],
    'effects' => [['income', +1, 'ifPlayer' => true, 'ifResource' => $crystal]],
  ],
  'resourceSiloJ' => [
    'id' => $id++,
    'image' => [
      $tower   => $image('HALLTOWR', 15, 'TBTWSILO', 'TOT',  'MRKS', 763, 66, 14, 'MARKS'),
    ],
    'town' => [$tower],
    'require' => ['marketplace'],
    'cost_ore' => 5,
    'cost_gold' => 5000,
    'name' => $spec[32][0],
    'description' => $spec[32][1],
    'effects' => [['income', +1, 'ifPlayer' => true, 'ifResource' => $gems]],
  ],
  'resourceSiloM' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 15, 'TBINSILO', 'TOI',  'MAR2', 496, -1, 14, 'MRK2'),
      $conflux => $image('HALLELEM', 15, 'TBELSILO', 'TOEL', 'SILO', 372, 89, 2, 'MARKS'),
    ],
    'town' => [$inferno, $conflux],
    'require' => ['marketplace'],
    'cost_ore' => 5,
    'cost_gold' => 5000,
    'name' => $spec[43][0],
    'description' => $spec[43][1],
    'effects' => [['income', +1, 'ifPlayer' => true, 'ifResource' => $mercury]],
  ],
  'resourceSiloS' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 15, 'TBDNSILO', 'TOD', 'SILO', 624, 5, 4, 'MARK2'),
    ],
    'town' => [$dungeon],
    'require' => ['marketplace'],
    'cost_ore' => 5,
    'cost_gold' => 5000,
    'name' => $spec[65][0],
    'description' => $spec[65][1],
    'effects' => [['income', +1, 'ifPlayer' => true, 'ifResource' => $sulfur]],
  ],

  // XXX=I:grl: with Aurora Borealis, replace all spells' icons with SPELLSCR.DEF frame 70
  'mageGuild1' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 0, 'TBCSMAGE', 'TOCS', 'MAG1', 707, 105, 36),
      $rampart => $image('HALLRAMP', 0, 'TBRMMAGE', 'TOR',  'MAG1', 454, 78,  86),
      $tower   => $image('HALLTOWR', 0, 'TBTWMAGE', 'TOT',  'GLD1', 597, 140, 1),
      $inferno => $image('HALLINFR', 0, 'TBINMAGE', 'TOI',  'MAG1A', 667, 153, 0, 'MAG1'),
      $necropolis => $image('HALLNECR', 0, 'TBNCMAGE', 'TON', 'MAG1', 341, 165, 1, 'MAGE1'),
      $dungeon => $image('HALLDUNG', 0, 'TBDNMAGE', 'TOD', 'MAG1', 164, 175, 0, 'MAGE1'),
      $stronghold => $image('HALLSTRN', 0, 'TBSTMAGE', 'TOS', 'MAG1', 473, 229, 0, 'MAGE1'),
      $fortress => $image('HALLFORT', 0, 'TBFRMAGE', 'TOF', 'MAG1A', 0, 72, 2, 'MAGE1'),
      $conflux => $image('HALLELEM', 0, 'TBELMAGE', 'TOEL', 'MAGE', 206, 79, 12, 'GLD1'),
    ],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'name' => $neut[0][0],
    'description' => $neut[0][1],
    'effects' => [
      ['town_spellCount', +5, true, 'ifSpellLevel' => 1],
    ],
  ],
  'mageGuild2' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 1, 'TBCSMAG2', 'TOCS', 'MAG2', 707, 105, 36),
      $rampart => $image('HALLRAMP', 1, 'TBRMMAG2', 'TOR',  'MAG2', 438, 78,  86),
      $tower   => $image('HALLTOWR', 1, 'TBTWMAG2', 'TOT',  'GLD2', 593, 140, 1),
      $inferno => $image('HALLINFR', 1, 'TBINMAG2', 'TOI',  'MAG2A', 667, 150, 0, 'MAG2'),
      $necropolis => $image('HALLNECR', 1, 'TBNCMAG2', 'TON', 'MAG2', 341, 165, 1, 'MAGE2'),
      $dungeon => $image('HALLDUNG', 1, 'TBDNMAG2', 'TOD', 'MAG2', 164, 175, 0, 'MAGE2'),
      $stronghold => $image('HALLSTRN', 1, 'TBSTMAG2', 'TOS', 'MAG2', 474, 229, 0, 'MAGE2'),
      $fortress => $image('HALLFORT', 1, 'TBFRMAG2', 'TOF', 'MAG2A', 0, 72, 2, 'MAGE2'),
      $conflux => $image('HALLELEM', 1, 'TBELMAG2', 'TOEL', 'MAG2', 206, 79, 12, 'GLD2'),
    ],
    'upgrade' => ['mageGuild1'],
    'require' => ['mageGuild1'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'cost_mercury' => 4,
    'cost_sulfur' => 4,
    'cost_crystal' => 4,
    'cost_gems' => 4,
    'name' => $neut[1][0],
    'description' => $neut[1][1],
    'effects' => [
      ['town_spellCount', +5, true, 'ifSpellLevel' => 1],
      ['town_spellCount', +4, true, 'ifSpellLevel' => 2],
    ],
  ],
  'mageGuild3' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 2, 'TBCSMAG3', 'TOCS', 'M301', 704, 105, 36, 'MAG3'),
      $rampart => $image('HALLRAMP', 2, 'TBRMMAG3', 'TOR',  'MAG3', 418, 78,  86),
      $tower   => $image('HALLTOWR', 2, 'TBTWMAG3', 'TOT',  'GLD3', 593, 140, 1),
      $inferno => $image('HALLINFR', 2, 'TBINMAG3', 'TOI',  'MAG3A', 667, 150, 0, 'MAG3'),
      $necropolis => $image('HALLNECR', 2, 'TBNCMAG3', 'TON', 'MAG3', 341, 165, 1, 'MAGE3'),
      $dungeon => $image('HALLDUNG', 2, 'TBDNMAG3', 'TOD', 'MAG3', 164, 175, 0, 'MAGE3'),
      $stronghold => $image('HALLSTRN', 2, 'TBSTMAG3', 'TOS', 'MAG3', 473, 229, 0, 'MAGE3'),
      $fortress => $image('HALLFORT', 2, 'TBFRMAG3', 'TOF', 'MAG3A', 0, 72, 2, 'MAGE3'),
      $conflux => $image('HALLELEM', 2, 'TBELMAG3', 'TOEL', 'MAG3', 206, 79, 12, 'GLD3'),
    ],
    'upgrade' => ['mageGuild2'],
    'require' => ['mageGuild2'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'cost_mercury' => 6,
    'cost_sulfur' => 6,
    'cost_crystal' => 6,
    'cost_gems' => 6,
    'name' => $neut[2][0],
    'description' => $neut[2][1],
    'effects' => [
      ['town_spellCount', +5, true, 'ifSpellLevel' => 1],
      ['town_spellCount', +4, true, 'ifSpellLevel' => 2],
      ['town_spellCount', +3, true, 'ifSpellLevel' => 3],
    ],
  ],
  'mageGuild4' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 3, 'TBCSMAG4', 'TOCS', 'M401', 704, 105, 36, 'MAG4'),
      $rampart => $image('HALLRAMP', 3, 'TBRMMAG4', 'TOR',  'MAG4', 406, 78,  86),
      $tower   => $image('HALLTOWR', 3, 'TBTWMAG4', 'TOT',  'GLD4', 593, 140, 1),
      $inferno => $image('HALLINFR', 3, 'TBINMAG4', 'TOI',  'MAG4A', 667, 150, 0, 'MAG4'),
      $necropolis => $image('HALLNECR', 3, 'TBNCMAG4', 'TON', 'MAG4', 340, 165, 1, 'MAGE4'),
      $dungeon => $image('HALLDUNG', 3, 'TBDNMAG4', 'TOD', 'MAG4', 164, 175, 0, 'MAGE4'),
      $conflux => $image('HALLELEM', 3, 'TBELMAG4', 'TOEL', 'MAG4', 206, 79, 12, 'GLD4'),
    ],
    'town' => [$castle, $rampart, $tower, $inferno, $necropolis, $dungeon, $conflux],
    'upgrade' => ['mageGuild3'],
    'require' => ['mageGuild3'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'cost_mercury' => 8,
    'cost_sulfur' => 8,
    'cost_crystal' => 8,
    'cost_gems' => 8,
    'name' => $neut[3][0],
    'description' => $neut[3][1],
    'effects' => [
      ['town_spellCount', +5, true, 'ifSpellLevel' => 1],
      ['town_spellCount', +4, true, 'ifSpellLevel' => 2],
      ['town_spellCount', +3, true, 'ifSpellLevel' => 3],
      ['town_spellCount', +2, true, 'ifSpellLevel' => 4],
    ],
  ],
  'mageGuild5' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 4, 'TBRMMAG5', 'TOR',  'MAG5', 384, 78, 86),
      $tower   => $image('HALLTOWR', 4, 'TBTWMAG5', 'TOT',  'GLD5', 593, 140, 1),
      $inferno => $image('HALLINFR', 4, 'TBINMAG5', 'TOI',  'MAG5A', 667, 150, 0, 'MAG5'),
      $necropolis => $image('HALLNECR', 4, 'TBNCMAG5', 'TON', 'MAG5', 343, 165, 1, 'MAGE5'),
      $dungeon => $image('HALLDUNG', 4, 'TBDNMAG5', 'TOD', 'MAG5', 164, 175, 0, 'MAGE5'),
      $conflux => $image('HALLELEM', 4, 'TBELMAG5', 'TOEL', 'MAG5', 206, 79, 12, 'GLD5'),
    ],
    'town' => [$rampart, $tower, $inferno, $necropolis, $dungeon, $conflux],
    'upgrade' => ['mageGuild4'],
    'require' => ['mageGuild4'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'cost_mercury' => 10,
    'cost_sulfur' => 10,
    'cost_crystal' => 10,
    'cost_gems' => 10,
    'name' => $neut[4][0],
    'description' => $neut[4][1],
    'effects' => [
      ['town_spellCount', +5, true, 'ifSpellLevel' => 1],
      ['town_spellCount', +4, true, 'ifSpellLevel' => 2],
      ['town_spellCount', +3, true, 'ifSpellLevel' => 3],
      ['town_spellCount', +2, true, 'ifSpellLevel' => 4],
      ['town_spellCount', +1, true, 'ifSpellLevel' => 5],
    ],
  ],

  // Castle
  'brotherhoodOfSword' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 22, 'TBCSEXT1', 'TOCS', 'TAV2', 0, 0, 40),
    ],
    'town' => [$castle],
    'upgrade' => ['tavern'],
    'require' => ['tavern'],
    'cost_wood' => 5,
    'cost_gold' => 500,
    'name' => $spec[5][0],
    'description' => $spec[5][1],
    'effects' => [
      ['creature_morale', +2, true, 'ifContext' => $combat],
      ['creature_morale', +2, 'ifContext' => $combat, 'ifGarrisoned' => true],
      ['creature_morale', +2, 'ifContext' => $combat, 'ifVisiting' => true],
    ],
  ],
  'stables' => [
    'id' => $id++,
    'image' => [
      // XXX=B fix $z, it must overlay shipyard
      $castle  => $image('HALLCSTL', 21, 'TBCSEXT0', 'TOCS', 'CAVM', 384, 123, 2, 'CV1S'),
      // XXX=I: dbst: there also exists BOCSCV2S.BMP and it's likely an $icon version used when trainingGroundsU is present but I dunno where BO* appear in SoD so can't check that, plus we don't have $iconU
    ],
    'town' => [$castle],
    'require' => ['fort', 'blacksmith', 'guardhouse', 'barracks'],
    'cost_wood' => 10,
    'cost_gold' => 2000,
    'name' => $spec[4][0],
    'description' => $spec[4][1],
    // XXX=C hero_actionPoints
    //
    // XXX=C does this stack? if you have 2 towns with 2 stables
    //
    // Matches effects of on-map Stables.
    'effects' => [
      bonus_effects([[$append, ['hero_actionPoints', +268, true, 'ifVehicle' => array_search('horse', AObject::vehicle), 'maxDays' => -1]], 'ifBonusObject' => true, 'ifBuilding' => true]),
      // In SoD, erecting Stables gives action points to visiting and garrisoned
      // heroes immediately (not on the next turn). Not so with Lighthouse.
      ['bonus_actionPoints', +6, 'ifTargetObject' => -1, 'ifVehicle' => array_search('horse', AObject::vehicle), 'ifBonusObject' => true, 'ifBuilding' => true],
      ['bonus_message', [$const, [$genr[581]]], 'ifBonusObject' => true, 'ifBuilding' => true],
    ],
  ],
  'griffinBastion' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 18, 'TBCSHRD1', 'TOCS', 'GR1H', 76, 196, 51),
    ],
    'imageU' => [
      $castle  => $image('HALLCSTL', 19, 'TBCSHRD2', 'TOCS', 'GR2H', 76, 196, 51),
    ],
    'ifU' => ['griffinTowerU'],
    'town' => [$castle],
    'require' => ['fort', 'blacksmith', 'guardhouse', 'griffinTower', 'barracks'],
    'cost_gold' => 1000,
    'name' => $spec[1][0],
    'description' => $spec[1][1],
    'descriptionU' => $spec[2][1],
    'effects' => [
      ['creature_growth', +3, true, 'ifCreature' => $griffin],
      ['creature_growth', +3, true, 'ifCreature' => $royalGriffin],
    ],
  ],
  'guardhouse' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 30, 'TBCSDW_0', 'TOCS', 'PIK1', 304, 197, 54),
    ],
    'town' => [$castle],
    'require' => ['fort'],
    'cost_ore' => 10,
    'cost_gold' => 500,
    'produce' => [$pikeman],
    'name' => $dwel[0][0],
    'description' => $dwel[0][1],
  ],
  'guardhouseU' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 37, 'TBCSUP_0', 'TOCS', 'PIK2', 304, 198, 54),
    ],
    'town' => [$castle],
    'upgrade' => ['guardhouse'],
    'require' => ['guardhouse', 'fort'],
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$pikeman, $halberdier],
    'name' => $dwel[7][0],
    'description' => $dwel[7][1],
  ],
  // XXX=B has some problems with the outline (geojson?) in the townscape
  'archerTower' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 31, 'TBCSDW_1', 'TOCS', 'CRS1', 360, 188, 58),
    ],
    'town' => [$castle],
    'require' => ['fort', 'guardhouse'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$archer],
    'name' => $dwel[1][0],
    'description' => $dwel[1][1],
  ],
  'archerTowerU' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 38, 'TBCSUP_1', 'TOCS', 'CRS2', 360, 188, 58),
    ],
    'town' => [$castle],
    'upgrade' => ['archerTower'],
    'require' => ['archerTower', 'fort', 'guardhouse'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$archer, $marksman],
    'name' => $dwel[8][0],
    'description' => $dwel[8][1],
  ],
  'griffinTower' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 32, 'TBCSDW_2', 'TOCS', 'GR1N', 76, 196, 50, 'GR1'),
    ],
    'town' => [$castle],
    'require' => ['fort', 'blacksmith', 'guardhouse', 'barracks'],
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$griffin],
    'name' => $dwel[2][0],
    'description' => $dwel[2][1],
  ],
  'griffinTowerU' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 39, 'TBCSUP_2', 'TOCS', 'GR2N', 76, 196, 50, 'GR2'),
    ],
    'town' => [$castle],
    'upgrade' => ['griffinTower'],
    'require' => ['griffinTower', 'fort', 'blacksmith', 'guardhouse', 'barracks'],
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$griffin, $royalGriffin],
    'name' => $dwel[9][0],
    'description' => $dwel[9][1],
  ],
  'barracks' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 33, 'TBCSDW_3', 'TOCS', 'SWD1', 176, 209, 62),
    ],
    'town' => [$castle],
    'require' => ['fort', 'blacksmith', 'guardhouse'],
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$swordsman],
    'name' => $dwel[3][0],
    'description' => $dwel[3][1],
  ],
  'barracksU' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 40, 'TBCSUP_3', 'TOCS', 'SWD2', 176, 209, 62),
    ],
    'town' => [$castle],
    'upgrade' => ['barracks'],
    'require' => ['barracks', 'fort', 'blacksmith', 'guardhouse'],
    'cost_ore' => 5,
    'cost_crystal' => 5,
    'cost_gold' => 2000,
    'produce' => [$swordsman, $crusader],
    'name' => $dwel[10][0],
    'description' => $dwel[10][1],
  ],
  'monastery' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 34, 'TBCSDW_4', 'TOCS', 'MON1', 563, 114, 66),
    ],
    'town' => [$castle],
    'require' => ['mageGuild1', 'fort', 'blacksmith', 'guardhouse', 'barracks'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 3000,
    'cost_mercury' => 2,
    'cost_sulfur' => 2,
    'cost_crystal' => 2,
    'cost_gems' => 2,
    'produce' => [$monk],
    'name' => $dwel[4][0],
    'description' => $dwel[4][1],
  ],
  'monasteryU' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 41, 'TBCSUP_4', 'TOCS', 'MON2', 563, 114, 66),
    ],
    'town' => [$castle],
    'upgrade' => ['monastery'],
    'require' => ['monastery', 'mageGuild1', 'fort', 'blacksmith', 'guardhouse', 'barracks'],
    'cost_wood' => 2,
    'cost_ore' => 2,
    'cost_gold' => 1000,
    'cost_mercury' => 2,
    'cost_sulfur' => 2,
    'cost_crystal' => 2,
    'cost_gems' => 2,
    'produce' => [$monk, $zealot],
    'name' => $dwel[11][0],
    'description' => $dwel[11][1],
  ],
  'trainingGrounds' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 35, 'TBCSDW_5', 'TOCS', 'CAV1', 174, 76, 3, 'CV1'),
    ],
    'town' => [$castle],
    'require' => ['fort', 'blacksmith', 'stables', 'guardhouse', 'barracks'],
    'cost_wood' => 20,
    'cost_gold' => 5000,
    'produce' => [$cavalier],
    'name' => $dwel[5][0],
    'description' => $dwel[5][1],
  ],
  'trainingGroundsU' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 42, 'TBCSUP_5', 'TOCS', 'CAV2', 160, 76, 3, 'CV2'),
    ],
    'town' => [$castle],
    'upgrade' => ['trainingGrounds'],
    'require' => ['trainingGrounds', 'fort', 'blacksmith', 'stables', 'guardhouse', 'barracks'],
    'cost_wood' => 10,
    'cost_gold' => 3000,
    'produce' => [$cavalier, $champion],
    'name' => $dwel[12][0],
    'description' => $dwel[12][1],
  ],
  'portalOfGlory' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 36, 'TBCSDW_6', 'TOCS', 'ANG1', 303, 258, 2),
    ],
    'town' => [$castle],
    'require' => ['mageGuild1', 'fort', 'blacksmith', 'guardhouse', 'barracks', 'monastery'],
    'cost_mercury' => 10,
    'cost_sulfur' => 10,
    'cost_crystal' => 10,
    'cost_gems' => 10,
    'cost_gold' => 20000,
    'produce' => [$angel],
    'name' => $dwel[6][0],
    'description' => $dwel[6][1],
  ],
  'portalOfGloryU' => [
    'id' => $id++,
    'image' => [
      $castle  => $image('HALLCSTL', 43, 'TBCSUP_6', 'TOCS', 'ANG2', 303, 258, 2),
    ],
    'town' => [$castle],
    'upgrade' => ['portalOfGlory'],
    'require' => ['portalOfGlory', 'mageGuild1', 'fort', 'blacksmith', 'guardhouse', 'barracks', 'monastery'],
    'cost_mercury' => 10,
    'cost_sulfur' => 10,
    'cost_crystal' => 10,
    'cost_gems' => 10,
    'cost_gold' => 20000,
    'produce' => [$angel, $archangel],
    'name' => $dwel[13][0],
    'description' => $dwel[13][1],
  ],

  // Rampart
  //
  // XXX=I
  'mysticPond' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 17, 'TBRMSPEC', 'TOR',  'GAR1A', 555, 0, 88, 'GAR1'),
    ],
    'town' => [$rampart],
    'cost_wood' => 2,
    'cost_ore' => 2,
    'cost_mercury' => 2,
    'cost_sulfur' => 2,
    'cost_crystal' => 2,
    'cost_gems' => 2,
    'cost_gold' => 2000,
    'name' => $spec[11][0],
    'description' => $spec[11][1],
  ],
  'fountainOfFortune' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 21, 'TBRMEXT0', 'TOR',  'GAR2A', 555, 0, 89, 'GAR2'),
    ],
    'town' => [$rampart],
    'upgrade' => ['mysticPond'],
    'require' => ['mysticPond'],
    'cost_crystal' => 10,
    'cost_gold' => 1500,
    'name' => $spec[15][0],
    'description' => $spec[15][1],
    'effects' => [
      ['creature_luck', +2, true, 'ifContext' => $combat],
      ['creature_luck', +2, 'ifContext' => $combat, 'ifGarrisoned' => true],
      ['creature_luck', +2, 'ifContext' => $combat, 'ifVisiting' => true],
    ],
  ],
  // XXX+I
  'treasury' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 22, 'TBRMEXT1', 'TOR',  'DWFT', 0, 172, 62),
    ],
    'town' => [$rampart],
    'require' => ['fort', 'minerGuild', 'centaurStables', 'dwarfCottage'],
    'cost_wood' => 5,
    'cost_ore' => 10,
    'cost_gold' => 5000,
    'name' => $spec[16][0],
    'description' => $spec[16][1],
  ],
  'minerGuild' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 18, 'TBRMHRD1', 'TOR',  'DWF1H', 0, 140, 61),
    ],
    'imageU' => [
      $rampart => $image('HALLRAMP', 19, 'TBRMHRD2', 'TOR',  'DWF2H', 0, 140, 61),
      // XXX=I:dbst: $icon variants exist:
      //     BORDWF1T BORDWF1H BORDWF1B BORDWF1
      //     BORDWF2T BORDWF2H BORDWF2B BORDWF2
    ],
    'ifU' => ['dwarfCottageU'],
    'town' => [$rampart],
    'require' => ['fort', 'centaurStables', 'dwarfCottage'],
    'cost_gold' => 1000,
    'name' => $spec[12][0],
    'description' => $spec[12][1],
    'descriptionU' => $spec[13][1],
    'effects' => [
      ['creature_growth', +4, true, 'ifCreature' => $dwarf],
      ['creature_growth', +4, true, 'ifCreature' => $battleDwarf],
    ],
  ],
  'dendroidSaplings' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 24, 'TBRMHRD3', 'TOR',  'TRE1H', 47, 92, 71),
    ],
    'imageU' => [
      $rampart => $image('HALLRAMP', 25, 'TBRMHRD4', 'TOR',  'TRE2H', 47, 92, 71),
    ],
    'ifU' => ['dendroidArchesU'],
    'town' => [$rampart],
    'require' => ['fort', 'centaurStables', 'homestead', 'dendroidArches'],
    'cost_gold' => 2000,
    'name' => $spec[18][0],
    'description' => $spec[18][1],
    'descriptionU' => $spec[19][1],
    'effects' => [
      ['creature_growth', +2, true, 'ifCreature' => $dendroidGuard],
      ['creature_growth', +2, true, 'ifCreature' => $dendroidSoldier],
    ],
  ],
  'centaurStables' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 30, 'TBRMDW_0', 'TOR',  'CEN1A', 0, 0, 73, 'CEN1'),
    ],
    'town' => [$rampart],
    'require' => ['fort'],
    'cost_wood' => 10,
    'cost_gold' => 500,
    'produce' => [$centaur],
    'name' => $dwel[14][0],
    'description' => $dwel[14][1],
  ],
  'centaurStablesU' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 37, 'TBRMUP_0', 'TOR',  'CEN2A', 0, 0, 73, 'CEN2'),
    ],
    'town' => [$rampart],
    'upgrade' => ['centaurStables'],
    'require' => ['centaurStables', 'fort'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'produce' => [$centaur, $centaurCaptain],
    'name' => $dwel[21][0],
    'description' => $dwel[21][1],
  ],
  'dwarfCottage' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 31, 'TBRMDW_1', 'TOR',  'DWF1', 0, 140, 60),
    ],
    'town' => [$rampart],
    'require' => ['fort', 'centaurStables'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'produce' => [$dwarf],
    'name' => $dwel[15][0],
    'description' => $dwel[15][1],
  ],
  'dwarfCottageU' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 38, 'TBRMUP_1', 'TOR',  'DWF2', 0, 140, 60),
    ],
    'town' => [$rampart],
    'upgrade' => ['dwarfCottage'],
    'require' => ['dwarfCottage', 'fort', 'centaurStables'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'produce' => [$dwarf, $battleDwarf],
    'name' => $dwel[22][0],
    'description' => $dwel[22][1],
  ],
  'homestead' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 32, 'TBRMDW_2', 'TOR',  'ELF1', 668, 174, 86),
    ],
    'town' => [$rampart],
    'require' => ['fort', 'centaurStables'],
    'cost_wood' => 10,
    'cost_gold' => 1500,
    'produce' => [$woodElf],
    'name' => $dwel[16][0],
    'description' => $dwel[16][1],
  ],
  'homesteadU' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 39, 'TBRMUP_2', 'TOR',  'ELF2', 665, 174, 86),
    ],
    'town' => [$rampart],
    'upgrade' => ['homestead'],
    'require' => ['homestead', 'fort', 'centaurStables'],
    'cost_wood' => 10,
    'cost_gold' => 1500,
    'produce' => [$woodElf, $grandElf],
    'name' => $dwel[23][0],
    'description' => $dwel[23][1],
  ],
  'enchantedSpring' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 33, 'TBRMDW_3', 'TOR',  'PEG1A', 287, 173, 81, 'PEG1'),
    ],
    'town' => [$rampart],
    'require' => ['fort', 'centaurStables', 'homestead'],
    'cost_crystal' => 10,
    'cost_gold' => 2000,
    'produce' => [$pegasus],
    'name' => $dwel[17][0],
    'description' => $dwel[17][1],
  ],
  'enchantedSpringU' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 40, 'TBRMUP_3', 'TOR',  'PEG2A', 287, 173, 81, 'PEG2'),
    ],
    'town' => [$rampart],
    'upgrade' => ['enchantedSpring'],
    'require' => ['enchantedSpring', 'fort', 'centaurStables', 'homestead'],
    'cost_crystal' => 5,
    'cost_gold' => 2000,
    'produce' => [$pegasus, $silverPegasus],
    'name' => $dwel[24][0],
    'description' => $dwel[24][1],
  ],
  'dendroidArches' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 34, 'TBRMDW_4', 'TOR',  'TRE1', 63, 92, 70),
    ],
    'town' => [$rampart],
    'require' => ['fort', 'centaurStables', 'homestead'],
    'cost_gold' => 2500,
    'produce' => [$dendroidGuard],
    'name' => $dwel[18][0],
    'description' => $dwel[18][1],
  ],
  'dendroidArchesU' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 41, 'TBRMUP_4', 'TOR',  'TRE2', 63, 92, 70),
    ],
    'town' => [$rampart],
    'upgrade' => ['dendroidArches'],
    'require' => ['dendroidArches', 'fort', 'centaurStables', 'homestead'],
    'cost_gold' => 1500,
    'produce' => [$dendroidGuard, $dendroidSoldier],
    'name' => $dwel[25][0],
    'description' => $dwel[25][1],
  ],
  'unicornGlade' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 35, 'TBRMDW_5', 'TOR',  'UNI1', 362, 175, 80),
    ],
    'town' => [$rampart],
    'require' => ['fort', 'centaurStables', 'homestead', 'enchantedSpring', 'dendroidArches'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gems' => 10,
    'cost_gold' => 4000,
    'produce' => [$unicorn],
    'name' => $dwel[19][0],
    'description' => $dwel[19][1],
  ],
  'unicornGladeU' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 42, 'TBRMUP_5', 'TOR',  'UNI2', 365, 175, 80),
    ],
    'town' => [$rampart],
    'upgrade' => ['unicornGlade'],
    'require' => ['unicornGlade', 'fort', 'centaurStables', 'homestead', 'enchantedSpring', 'dendroidArches'],
    'cost_gems' => 5,
    'cost_gold' => 3000,
    'produce' => [$unicorn, $warUnicorn],
    'name' => $dwel[26][0],
    'description' => $dwel[26][1],
  ],
  'dragonCliffs' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 36, 'TBRMDW_6', 'TOR',  'DR1AA', 502, 230, 84, 'DRA1'),
    ],
    'town' => [$rampart],
    'require' => ['mageGuild2', 'fort', 'centaurStables', 'homestead', 'enchantedSpring', 'dendroidArches', 'unicornGlade'],
    'cost_ore' => 30,
    'cost_crystal' => 20,
    'cost_gold' => 10000,
    'produce' => [$greenDragon],
    'name' => $dwel[20][0],
    'description' => $dwel[20][1],
  ],
  'dragonCliffsU' => [
    'id' => $id++,
    'image' => [
      $rampart => $image('HALLRAMP', 43, 'TBRMUP_6', 'TOR',  'DR2AA', 502, 231, 84, 'DRA2'),
    ],
    'town' => [$rampart],
    'upgrade' => ['dragonCliffs'],
    'require' => ['dragonCliffs', 'mageGuild3', 'fort', 'centaurStables', 'homestead', 'enchantedSpring', 'dendroidArches', 'unicornGlade'],
    'cost_ore' => 30,
    'cost_crystal' => 20,
    'cost_gold' => 20000,
    'produce' => [$greenDragon, $goldDragon],
    'name' => $dwel[27][0],
    'description' => $dwel[27][1],
  ],

  // Tower
  'library' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 22, 'TBTWEXT1', 'TOT',  'GLDL', 702, 167, 2),
    ],
    'town' => [$tower],
    'require' => ['mageGuild1'],
    'cost_wood' => 5,
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_sulfur' => 5,
    'cost_crystal' => 5,
    'cost_gems' => 5,
    'cost_gold' => 1500,
    'name' => $spec[27][0],
    'description' => $spec[27][1],
    'effects' => [
      // Give 1 extra spell on every level but only if Mage Guild is present.
      ['town_spellCount', 1.20, true, 'ifSpellLevel' => 1],
      ['town_spellCount', 1.25, true, 'ifSpellLevel' => 2],
      ['town_spellCount', 1.34, true, 'ifSpellLevel' => 3],
      ['town_spellCount', 1.50, true, 'ifSpellLevel' => 4],
      ['town_spellCount', 2.00, true, 'ifSpellLevel' => 5],
    ],
  ],
  'wallOfKnowledge' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 23, 'TBTWEXT2', 'TOT',  'GLDW', 593, 140, 2),
    ],
    'town' => [$tower],
    'require' => ['mageGuild1'],
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'name' => $spec[28][0],
    'description' => $spec[28][1],
    'effects' => [
      bonus_effects([[$append, ['hero_knowledge', +1, true]], 'ifBonusObject' => true, 'ifBuilding' => true]),
      ['bonus_message', [$const, [toMarkup($genr[582], '`<`{StatImage knowledge`} +1 Knowledge`>')]], 'ifBonusObject' => true, 'ifBuilding' => true],
    ],
  ],
  'lookoutTower' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 21, 'TBTWEXT0', 'TOT',  'CASW', 409, 101, 0, 'CASTW'),
    ],
    'town' => [$tower],
    'require' => ['fort'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'name' => $spec[26][0],
    'description' => $spec[26][1],
    'effects' => [
      ['town_shroud', [$clamp, 20], true],
    ],
  ],
  'sculptorWings' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 18, 'TBTWHRD1', 'TOT',  'GAR1H', 0, 232, 0, 'GA1H'),
    ],
    'imageU' => [
      $tower  => $image('HALLTOWR', 19, 'TBTWHRD2', 'TOT',  'GAR2H', 0, 232, 0, 'GA2H'),
    ],
    'ifU' => ['parapetU'],
    'town' => [$tower],
    'require' => ['fort', 'workshop', 'parapet'],
    'cost_gold' => 1000,
    'name' => $spec[23][0],
    'description' => $spec[23][1],
    'descriptionU' => $spec[24][1],
    'effects' => [
      ['creature_growth', +4, true, 'ifCreature' => $stoneGargoyle],
      ['creature_growth', +4, true, 'ifCreature' => $obsidianGargoyle],
    ],
  ],
  'workshop' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 30, 'TBTWDW_0', 'TOT',  'GRM1A', 453, 82, 0, 'GREM1'),
    ],
    'town' => [$tower],
    'require' => ['fort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 300,
    'produce' => [$gremlin],
    'name' => $dwel[28][0],
    'description' => $dwel[28][1],
  ],
  'workshopU' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 37, 'TBTWUP_0', 'TOT',  'GRM2A', 446, 82, 0, 'GREM2'),
    ],
    'town' => [$tower],
    'upgrade' => ['workshop'],
    'require' => ['workshop', 'fort'],
    'cost_gold' => 1000,
    'produce' => [$gremlin, $masterGremlin],
    'name' => $dwel[35][0],
    'description' => $dwel[35][1],
  ],
  'parapet' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 31, 'TBTWDW_1', 'TOT',  'GAR1', 4, 232, 2),
    ],
    'town' => [$tower],
    'require' => ['fort', 'workshop'],
    'cost_ore' => 10,
    'cost_gold' => 1000,
    'produce' => [$stoneGargoyle],
    'name' => $dwel[29][0],
    'description' => $dwel[29][1],
  ],
  'parapetU' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 38, 'TBTWUP_1', 'TOT',  'GAR2', 4, 232, 2),
    ],
    'town' => [$tower],
    'upgrade' => ['parapet'],
    'require' => ['parapet', 'fort', 'workshop'],
    'cost_ore' => 5,
    'cost_gold' => 1500,
    'produce' => [$stoneGargoyle, $obsidianGargoyle],
    'name' => $dwel[36][0],
    'description' => $dwel[36][1],
  ],
  'golemFactory' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 32, 'TBTWDW_2', 'TOT',  'GOL1A', 209, 70, 2, 'GOLM1'),
    ],
    'town' => [$tower],
    'require' => ['fort', 'workshop'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$stoneGolem],
    'name' => $dwel[30][0],
    'description' => $dwel[30][1],
  ],
  'golemFactoryU' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 39, 'TBTWUP_2', 'TOT',  'GOL2A', 209, 70, 2, 'GOLM2'),
    ],
    'town' => [$tower],
    'upgrade' => ['golemFactory'],
    'require' => ['golemFactory', 'fort', 'workshop'],
    'cost_wood' => 5,
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$stoneGolem, $ironGolem],
    'name' => $dwel[37][0],
    'description' => $dwel[37][1],
  ],
  'mageTower' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 33, 'TBTWDW_3', 'TOT',  'MAG1', 613, 157, 0),
    ],
    'town' => [$tower],
    'require' => ['mageGuild1', 'fort', 'workshop', 'parapet', 'golemFactory'],
    'cost_wood' => 5,
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_sulfur' => 5,
    'cost_crystal' => 5,
    'cost_gems' => 5,
    'cost_gold' => 2000,
    'produce' => [$mage],
    'name' => $dwel[31][0],
    'description' => $dwel[31][1],
  ],
  'mageTowerU' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 40, 'TBTWUP_3', 'TOT',  'MAG2', 613, 157, 0),
    ],
    'town' => [$tower],
    'upgrade' => ['mageTower'],
    'require' => ['mageTower', 'fort', 'library', 'workshop', 'parapet', 'golemFactory'],
    'cost_wood' => 5,
    'cost_gold' => 2000,
    'produce' => [$mage, $archMage],
    'name' => $dwel[38][0],
    'description' => $dwel[38][1],
  ],
  'altarOfWishes' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 34, 'TBTWDW_4', 'TOT',  'GEN1', 511, 215, 0),
    ],
    'town' => [$tower],
    'require' => ['mageGuild1', 'fort', 'workshop', 'parapet', 'golemFactory', 'mageTower'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_crystal' => 6,
    'cost_gems' => 6,
    'cost_gold' => 3000,
    'produce' => [$genie],
    'name' => $dwel[32][0],
    'description' => $dwel[32][1],
  ],
  'altarOfWishesU' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 41, 'TBTWUP_4', 'TOT',  'GEN2', 511, 215, 0),
    ],
    'town' => [$tower],
    'upgrade' => ['altarOfWishes'],
    'require' => ['altarOfWishes', 'fort', 'workshop', 'parapet', 'golemFactory', 'mageTower'],
    'cost_wood' => 5,
    'cost_gold' => 2000,
    'produce' => [$genie, $masterGenie],
    'name' => $dwel[39][0],
    'description' => $dwel[39][1],
  ],
  'goldenPavilion' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 35, 'TBTWDW_5', 'TOT',  'NAG1', 681, 100, 4, 'NAGA1'),
    ],
    'town' => [$tower],
    'require' => ['mageGuild1', 'fort', 'workshop', 'parapet', 'golemFactory', 'mageTower'],
    'cost_wood' => 5,
    'cost_mercury' => 2,
    'cost_ore' => 5,
    'cost_sulfur' => 2,
    'cost_crystal' => 2,
    'cost_gems' => 2,
    'cost_gold' => 4000,
    'produce' => [$naga],
    'name' => $dwel[33][0],
    'description' => $dwel[33][1],
  ],
  'goldenPavilionU' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 42, 'TBTWUP_5', 'TOT',  'NAG2', 681, 100, 4, 'NAGA2'),
    ],
    'town' => [$tower],
    'upgrade' => ['goldenPavilion'],
    'require' => ['goldenPavilion', 'mageGuild1', 'fort', 'workshop', 'parapet', 'golemFactory', 'mageTower'],
    'cost_mercury' => 3,
    'cost_sulfur' => 3,
    'cost_crystal' => 3,
    'cost_gems' => 3,
    'cost_gold' => 3000,
    'produce' => [$naga, $nagaQueen],
    'name' => $dwel[40][0],
    'description' => $dwel[40][1],
  ],
  'cloudTemple' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 36, 'TBTWDW_6', 'TOT',  'TIT1', 75, 144, 0),
    ],
    'town' => [$tower],
    'require' => ['mageGuild1', 'fort', 'workshop', 'parapet', 'golemFactory', 'mageTower', 'altarOfWishes', 'goldenPavilion'],
    'cost_wood' => 10,
    'cost_ore' => 10,
    'cost_gems' => 10,
    'cost_gold' => 5000,
    'produce' => [$giant],
    'name' => $dwel[34][0],
    'description' => $dwel[34][1],
  ],
  'cloudTempleU' => [
    'id' => $id++,
    'image' => [
      $tower  => $image('HALLTOWR', 43, 'TBTWUP_6', 'TOT',  'TIT2', 75, 144, 0),
    ],
    'town' => [$tower],
    'upgrade' => ['cloudTemple'],
    'require' => ['cloudTemple', 'mageGuild1', 'fort', 'workshop', 'parapet', 'golemFactory', 'mageTower', 'altarOfWishes', 'goldenPavilion'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_crystal' => 30,
    'cost_gold' => 25000,
    'produce' => [$giant, $titan],
    'name' => $dwel[41][0],
    'description' => $dwel[41][1],
  ],

  // Inferno
  'orderOfFire' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 23, 'TBINEXT2', 'TOI',  'PAIN', 593, 146, 6, 'MAGO'),
    ],
    'town' => [$inferno],
    'require' => ['mageGuild1'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'name' => $spec[39][0],
    'description' => $spec[39][1],
    'effects' => [
      bonus_effects([[$append, ['hero_spellPower', +1, true]], 'ifBonusObject' => true, 'ifBuilding' => true]),
      ['bonus_message', [$const, [toMarkup($genr[583], '`<`{StatImage spellPower`} +1 Spell Power`>')]], 'ifBonusObject' => true, 'ifBuilding' => true],
    ],
  ],
  'brimstoneStormclouds' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 21, 'TBINEXT0', 'TOI',  'CAB1A', 297, 310, 0, 'CASB'),
    ],
    'town' => [$inferno],
    'require' => ['fort'],
    'cost_sulfur' => 5,
    'cost_gold' => 1000,
    'name' => $spec[37][0],
    'description' => $spec[37][1],
    'effects' => [
      ['hero_spellPower', +2, true, 'ifContext' => $combat],
      ['hero_spellPower', +2, 'ifContext' => $combat, 'ifGarrisoned' => true],
      ['hero_spellPower', +2, 'ifContext' => $combat, 'ifVisiting' => true],
    ],
  ],
  // XXX=I
  'castleGate' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 22, 'TBINEXT1', 'TOI',  'CASGA', 227, 136, 2, 'CASG'),
    ],
    'town' => [$inferno],
    'require' => ['castle'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 10000,
    'name' => $spec[38][0],
    'description' => $spec[38][1],
  ],
  'birthingPools' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 18, 'TBINHRD1', 'TOI',  'MP1HA', 614, 56, 0, 'IMPH'),
    ],
    'imageU' => [
      $inferno => $image('HALLINFR', 19, 'TBINHRD2', 'TOI',  'MP2HA', 614, 56, 0, 'IMP2H'),
    ],
    'ifU' => ['impCrucibleU'],
    'town' => [$inferno],
    'require' => ['fort', 'impCrucible'],
    'cost_gold' => 1000,
    'name' => $spec[34][0],
    'description' => $spec[34][1],
    'descriptionU' => $spec[35][1],
    'effects' => [
      ['creature_growth', +8, true, 'ifCreature' => $imp],
      ['creature_growth', +8, true, 'ifCreature' => $familiar],
    ],
  ],
  'cages' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 24, 'TBINHRD3', 'TOI',  'HND1H', 9, 11, 0, 'HNDH'),
    ],
    'imageU' => [
      $inferno => $image('HALLINFR', 25, 'TBINHRD4', 'TOI',  'HND2H', 9, 11, 0, 'HND2H'),
    ],
    'ifU' => ['kennelsU'],
    'town' => [$inferno],
    'require' => ['fort', 'impCrucible', 'kennels'],
    'cost_gold' => 1000,
    'name' => $spec[40][0],
    'description' => $spec[40][1],
    'descriptionU' => $spec[41][1],
    'effects' => [
      ['creature_growth', +3, true, 'ifCreature' => $hellHound],
      ['creature_growth', +3, true, 'ifCreature' => $cerberus],
    ],
  ],
  'impCrucible' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 30, 'TBINDW_0', 'TOI',  'MP1A', 614, 56, 0, 'IMP1'),
    ],
    'town' => [$inferno],
    'require' => ['fort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 300,
    'produce' => [$imp],
    'name' => $dwel[42][0],
    'description' => $dwel[42][1],
  ],
  'impCrucibleU' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 37, 'TBINUP_0', 'TOI',  'MP2A', 614, 56, 0, 'IMP2'),
    ],
    'town' => [$inferno],
    'upgrade' => ['impCrucible'],
    'require' => ['impCrucible', 'fort'],
    'cost_gold' => 1000,
    'produce' => [$imp, $familiar],
    'name' => $dwel[49][0],
    'description' => $dwel[49][1],
  ],
  'hallOfSins' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 31, 'TBINDW_1', 'TOI',  'GOG1A', 187, 0, 6, 'GOG1'),
    ],
    'town' => [$inferno],
    'require' => ['fort', 'impCrucible'],
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$gog],
    'name' => $dwel[43][0],
    'description' => $dwel[43][1],
  ],
  'hallOfSinsU' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 38, 'TBINUP_1', 'TOI',  'GOG2A', 187, 0, 6, 'GOG2'),
    ],
    'town' => [$inferno],
    'upgrade' => ['hallOfSins'],
    'require' => ['hallOfSins', 'fort', 'impCrucible'],
    'cost_mercury' => 5,
    'cost_gold' => 1000,
    'produce' => [$gog, $magog],
    'name' => $dwel[50][0],
    'description' => $dwel[50][1],
  ],
  'kennels' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 32, 'TBINDW_2', 'TOI',  'HND1', 9, 11, 0),
    ],
    'town' => [$inferno],
    'require' => ['fort', 'impCrucible'],
    'cost_wood' => 10,
    'cost_gold' => 1500,
    'produce' => [$hellHound],
    'name' => $dwel[44][0],
    'description' => $dwel[44][1],
  ],
  'kennelsU' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 39, 'TBINUP_2', 'TOI',  'HND2', 9, 11, 0),
    ],
    'town' => [$inferno],
    'upgrade' => ['kennels'],
    'require' => ['kennels', 'fort', 'impCrucible'],
    'cost_sulfur' => 5,
    'cost_gold' => 1500,
    'produce' => [$hellHound, $cerberus],
    'name' => $dwel[51][0],
    'description' => $dwel[51][1],
  ],
  'demonGate' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 33, 'TBINDW_3', 'TOI',  'DMN1', 414, 78, 6),
    ],
    'town' => [$inferno],
    'require' => ['fort', 'impCrucible', 'hallOfSins'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$demon],
    'name' => $dwel[45][0],
    'description' => $dwel[45][1],
  ],
  'demonGateU' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 40, 'TBINUP_3', 'TOI',  'DMN2', 414, 79, 6),
    ],
    'town' => [$inferno],
    'upgrade' => ['demonGate'],
    'require' => ['demonGate', 'fort', 'hallOfSins'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$demon, $hornedDemon],
    'name' => $dwel[52][0],
    'description' => $dwel[52][1],
  ],
  'hellHole' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 34, 'TBINDW_4', 'TOI',  'PIT1', 359, 22, 8),
    ],
    'town' => [$inferno],
    'require' => ['fort', 'impCrucible', 'hallOfSins', 'demonGate'],
    'cost_gold' => 3000,
    'produce' => [$pitFiend],
    'name' => $dwel[46][0],
    'description' => $dwel[46][1],
  ],
  'hellHoleU' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 41, 'TBINUP_4', 'TOI',  'PIT2', 359, 23, 8),
    ],
    'town' => [$inferno],
    'upgrade' => ['hellHole'],
    'require' => ['hellHole', 'mageGuild2', 'fort', 'impCrucible', 'hallOfSins', 'demonGate'],
    'cost_mercury' => 5,
    'cost_sulfur' => 5,
    'cost_gold' => 3000,
    'produce' => [$pitFiend, $pitLord],
    'name' => $dwel[53][0],
    'description' => $dwel[53][1],
  ],
  'fireLake' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 35, 'TBINDW_5', 'TOI',  'EFR1', 220, 0, 8),
    ],
    'town' => [$inferno],
    'require' => ['mageGuild1', 'fort', 'impCrucible', 'hallOfSins', 'demonGate'],
    'cost_mercury' => 3,
    'cost_ore' => 10,
    'cost_sulfur' => 3,
    'cost_gems' => 3,
    'cost_gold' => 4000,
    'produce' => [$efreeti],
    'name' => $dwel[47][0],
    'description' => $dwel[47][1],
  ],
  'fireLakeU' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 42, 'TBINUP_5', 'TOI',  'EFR2', 220, 1, 8),
    ],
    'town' => [$inferno],
    'upgrade' => ['fireLake'],
    'require' => ['fireLake', 'mageGuild1', 'fort', 'impCrucible', 'hallOfSins', 'demonGate'],
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_sulfur' => 5,
    'cost_gems' => 5,
    'cost_gold' => 3000,
    'produce' => [$efreeti, $efreetSultan],
    'name' => $dwel[54][0],
    'description' => $dwel[54][1],
  ],
  'forsakenPalace' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 36, 'TBINDW_6', 'TOI',  'DVL1', 420, 128, 0),
    ],
    'town' => [$inferno],
    'require' => ['mageGuild1', 'fort', 'impCrucible', 'hallOfSins', 'demonGate', 'hellHole', 'fireLake'],
    'cost_wood' => 10,
    'cost_mercury' => 20,
    'cost_ore' => 10,
    'cost_gold' => 15000,
    'produce' => [$devil],
    'name' => $dwel[48][0],
    'description' => $dwel[48][1],
  ],
  'forsakenPalaceU' => [
    'id' => $id++,
    'image' => [
      $inferno => $image('HALLINFR', 43, 'TBINUP_6', 'TOI',  'DVL2', 420, 127, 0),
    ],
    'town' => [$inferno],
    'upgrade' => ['forsakenPalace'],
    'require' => ['forsakenPalace', 'mageGuild1', 'fort', 'impCrucible', 'hallOfSins', 'demonGate', 'hellHole', 'fireLake'],
    'cost_wood' => 5,
    'cost_mercury' => 20,
    'cost_ore' => 5,
    'cost_gold' => 20000,
    'produce' => [$devil, $archDevil],
    'name' => $dwel[55][0],
    'description' => $dwel[55][1],
  ],

  // Necropolis
  'necromancyAmplifier' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 21, 'TBNCEXT0', 'TON',  'NECRA', 307, 163, 0, 'NECRO'),
    ],
    'town' => [$necropolis],
    'require' => ['mageGuild1'],
    'cost_gold' => 1000,
    'name' => $spec[48][0],
    'description' => $spec[48][1],
    'effects' => [
      ['creature_reanimate', 0.10, 'ifPlayer' => true],
    ],
  ],
  'coverOfDarkness' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 17, 'TBNCSPEC', 'TON',  'SHRDA', 18, 143, 0, 'SHROD'),
    ],
    'town' => [$necropolis],
    'require' => ['fort'],
    'cost_gold' => 1000,
    'name' => $spec[44][0],
    'description' => $spec[44][1],
    // Matches effects of on-map Cover of Darkness.
    'effects' => [
      // XXX=C is it applied immediately or on next turn of this player?
      [
        'bonus_shroud',
        [
          $append,
          ['WithinCircle', null, null, 20, null, null, $constants['shroud']['cartographer'], false],
          ['WithinCircle', null, null, 20, null, null, $constants['shroud']['observatory'], false],
          ['WithinCircle', null, null, 20, null, null, $constants['shroud']['eyeOfMagi'], false],
        ],
        'ifPlayer' => true,
        'ifTargetPlayer' => -1,
        'isTargetEnemy' => true,
        'ifObject' => 0,
        'ifBonusObject' => 0,
      ],
    ],
  ],
  // XXX=I
  'skeletonTransformer' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 22, 'TBNCEXT1', 'TON',  'SKELT', 247, 62, 4),
    ],
    'town' => [$necropolis],
    'require' => ['fort', 'cursedTemple'],
    'cost_gold' => 10000,
    'name' => $spec[49][0],
    'description' => $spec[49][1],
  ],
  // XXX=B overlays cursedTempleU/U, preventing on-click event (in SoD click on unearthedGraves acts as a click on cursedTempleU)
  'unearthedGraves' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 18, 'TBNCHRD1', 'TON',  'SKE1H', 80, 22, 5, 'SKELH'),
    ],
    'imageU' => [
      $necropolis => $image('HALLNECR', 19, 'TBNCHRD2', 'TON',  'SKE2H', 64, 22, 5, 'SKELH'),
    ],
    'ifU' => ['cursedTempleU'],
    'town' => [$necropolis],
    'require' => ['fort', 'skeletonTransformer', 'cursedTemple'],
    'cost_gold' => 1000,
    'name' => $spec[45][0],
    'description' => $spec[45][1],
    'descriptionU' => $spec[46][1],
    'effects' => [
      ['creature_growth', +6, true, 'ifCreature' => $skeleton],
      ['creature_growth', +6, true, 'ifCreature' => $skeletonWarrior],
    ],
  ],
  'cursedTemple' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 30, 'TBNCDW_0', 'TON',  'SKEL1', 80, 44, 4),
    ],
    'town' => [$necropolis],
    'require' => ['fort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 400,
    'produce' => [$skeleton],
    'name' => $dwel[56][0],
    'description' => $dwel[56][1],
  ],
  'cursedTempleU' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 37, 'TBNCUP_0', 'TON',  'SKEL2', 64, 35, 4),
    ],
    'town' => [$necropolis],
    'upgrade' => ['cursedTemple'],
    'require' => ['cursedTemple', 'fort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$skeleton, $skeletonWarrior],
    'name' => $dwel[63][0],
    'description' => $dwel[63][1],
  ],
  'graveyard' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 31, 'TBNCDW_1', 'TON',  'ZOMB1', 502, 77, 8),
    ],
    'town' => [$necropolis],
    'require' => ['fort', 'cursedTemple'],
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$walkingDead],
    'name' => $dwel[57][0],
    'description' => $dwel[57][1],
  ],
  'graveyardU' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 38, 'TBNCUP_1', 'TON',  'ZOMB2', 498, 73, 8),
    ],
    'town' => [$necropolis],
    'upgrade' => ['graveyard'],
    'require' => ['graveyard', 'fort', 'cursedTemple'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$walkingDead, $zombie],
    'name' => $dwel[64][0],
    'description' => $dwel[64][1],
  ],
  'tombOfSouls' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 32, 'TBNCDW_2', 'TON',  'WIGH1', 0, 0, 16),
    ],
    'town' => [$necropolis],
    'require' => ['fort', 'cursedTemple'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1500,
    'produce' => [$wight],
    'name' => $dwel[58][0],
    'description' => $dwel[58][1],
  ],
  'tombOfSoulsU' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 39, 'TBNCUP_2', 'TON',  'WIGH2', 0, 0, 16),
    ],
    'town' => [$necropolis],
    'upgrade' => ['tombOfSouls'],
    'require' => ['tombOfSouls', 'fort', 'cursedTemple'],
    'cost_mercury' => 5,
    'cost_gold' => 1500,
    'produce' => [$wight, $wraith],
    'name' => $dwel[65][0],
    'description' => $dwel[65][1],
  ],
  'estate' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 33, 'TBNCDW_3', 'TON',  'VAM1', 607, 99, 6, 'VAMP1'),
    ],
    'town' => [$necropolis],
    'require' => ['fort', 'cursedTemple', 'graveyard'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$vampire],
    'name' => $dwel[59][0],
    'description' => $dwel[59][1],
  ],
  'estateU' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 40, 'TBNCUP_3', 'TON',  'VAM2', 615, 98, 6, 'VAMP2'),
    ],
    'town' => [$necropolis],
    'upgrade' => ['estate'],
    'require' => ['estate', 'mageGuild1', 'fort', 'necromancyAmplifier', 'cursedTemple', 'graveyard'],
    'cost_wood' => 5,
    'cost_crystal' => 10,
    'cost_gems' => 10,
    'cost_gold' => 2000,
    'produce' => [$vampire, $vampireLord],
    'name' => $dwel[66][0],
    'description' => $dwel[66][1],
  ],
  'mausoleum' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 34, 'TBNCDW_4', 'TON',  'LICH1', 206, 82, 3),
    ],
    'town' => [$necropolis],
    // Despite the fact Meusoleum is placed under Estate in SoD editor, it
    // doesn't require it (nor mausoleumu does).
    'require' => ['mageGuild1', 'fort', 'cursedTemple', 'graveyard'],
    'cost_ore' => 10,
    'cost_sulfur' => 10,
    'cost_gold' => 2000,
    'produce' => [$lich],
    'name' => $dwel[60][0],
    'description' => $dwel[60][1],
  ],
  'mausoleumU' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 41, 'TBNCUP_4', 'TON',  'LICH2', 222, 83, 3),
    ],
    'town' => [$necropolis],
    'upgrade' => ['mausoleum'],
    'require' => ['mausoleum', 'mageGuild1', 'fort', 'cursedTemple', 'graveyard'],
    'cost_ore' => 5,
    'cost_sulfur' => 5,
    'cost_gold' => 2000,
    'produce' => [$lich, $powerLich],
    'name' => $dwel[67][0],
    'description' => $dwel[67][1],
  ],
  'hallOfDarkness' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 35, 'TBNCDW_5', 'TON',  'BKN1', 0, 151, 0, 'BKNI1'),
    ],
    'town' => [$necropolis],
    'require' => ['mageGuild1', 'fort', 'cursedTemple', 'graveyard', 'estate', 'mausoleum'],
    'cost_wood' => 10,
    'cost_ore' => 10,
    'cost_gold' => 6000,
    'produce' => [$blackKnight],
    'name' => $dwel[61][0],
    'description' => $dwel[61][1],
  ],
  'hallOfDarknessU' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 42, 'TBNCUP_5', 'TON',  'BKN2', 0, 151, 0, 'BKNI2'),
    ],
    'town' => [$necropolis],
    'upgrade' => ['hallOfDarkness'],
    'require' => ['hallOfDarkness', 'mageGuild1', 'fort', 'cursedTemple', 'graveyard', 'estate', 'mausoleum'],
    'cost_wood' => 5,
    'cost_mercury' => 2,
    'cost_ore' => 5,
    'cost_sulfur' => 2,
    'cost_crystal' => 2,
    'cost_gems' => 2,
    'cost_gold' => 3000,
    'produce' => [$blackKnight, $dreadKnight],
    'name' => $dwel[68][0],
    'description' => $dwel[68][1],
  ],
  'dragonVault' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 36, 'TBNCDW_6', 'TON',  'BON1', 663, 185, 0, 'BONE1'),
    ],
    'town' => [$necropolis],
    'require' => ['mageGuild1', 'fort', 'cursedTemple', 'graveyard', 'estate', 'mausoleum', 'hallOfDarkness'],
    'cost_wood' => 5,
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_sulfur' => 5,
    'cost_crystal' => 5,
    'cost_gems' => 5,
    'cost_gold' => 10000,
    'produce' => [$boneDragon],
    'name' => $dwel[62][0],
    'description' => $dwel[62][1],
  ],
  'dragonVaultU' => [
    'id' => $id++,
    'image' => [
      $necropolis => $image('HALLNECR', 43, 'TBNCUP_6', 'TON',  'BON2', 662, 183, 0, 'BONE2'),
    ],
    'town' => [$necropolis],
    'upgrade' => ['dragonVault'],
    'require' => ['dragonVault', 'mageGuild1', 'fort', 'cursedTemple', 'graveyard', 'estate', 'mausoleum', 'hallOfDarkness'],
    'cost_wood' => 5,
    'cost_mercury' => 20,
    'cost_ore' => 5,
    'cost_gold' => 15000,
    'produce' => [$boneDragon, $ghostDragon],
    'name' => $dwel[69][0],
    'description' => $dwel[69][1],
  ],

  // Dungeon
  'manaVortex' => [
    'id' => $manaVortex = $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 21, 'TBDNEXT0', 'TOD',  'VOR1A', 133, 313, 2, 'VORT'),
    ],
    'town' => [$dungeon],
    'require' => ['mageGuild1'],
    'cost_gold' => 1000,
    'name' => $spec[59][0],
    'description' => $spec[59][1],
    // Partially matches effects of on-map Magic Spring.
    //
    // Mana Vortex grants the bonus only once per week. If a week starts and a hero sits in the town, he doesn't get any bonus until the user opens the town's screen. If there are both visiting and garrisoned heroes, the latter gets the bonus (the game just iterates over both heroes starting with the garrisoned one - if you have Battle Scholar Academy then both heroes get the bonus).
    'effects' => [
      ['quest_fulfilled', [$check, 'spellPointsMax', 0, 2], 'ifBonusObject' => true, 'ifBuilding' => true],
      ['bonus_spellPoints', [$custom, 'rules'], 'ifTargetObject' => -1, 'ifBonusObject' => true, 'ifBuilding' => true],
      ['bonus_spellPoints', 2.0, 'ifTargetObject' => -1, 'ifBonusObject' => true, 'ifBuilding' => true],
      bonus_effects([[$append, ['quest_fulfilled', [$const, false], 'ifBonusObject' => true, 'ifBuilding' => $manaVortex, 'maxDays' => -1]], 'ifBonusObject' => true, 'ifBuilding' => true]),
      ['bonus_message', [$const, [$genr[580]]], 'ifBonusObject' => true, 'ifBuilding' => true],
    ],
  ],
  // XXX=I
  'portalOfSummoning' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 22, 'TBDNEXT1', 'TOD',  'PORTA', 687, 97, 0, 'PORT'),
    ],
    'town' => [$dungeon],
    'cost_ore' => 5,
    'cost_gold' => 2500,
    'name' => $spec[60][0],
    'description' => $spec[60][1],
  ],
  'battleScholarAcademy' => [
    'id' => $battleScholarAcademy = $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 23, 'TBDNEXT2', 'TOD',  'ACAD', 313, 0, 2),
    ],
    'town' => [$dungeon],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'name' => $spec[61][0],
    'description' => $spec[61][1],
    'effects' => [
      ['bonus_experience', +1000, 'ifTargetObject' => -1, 'ifBonusObject' => true, 'ifBuilding' => true],
      bonus_effects([[$append, ['quest_fulfilled', [$const, false], true, 'ifBonusObject' => true, 'ifBuilding' => $battleScholarAcademy]], 'ifBonusObject' => true, 'ifBuilding' => true]),
      ['bonus_message', [$const, [toMarkup($genr[584], '`<`{StatImage experience`} 1000`>')]], 'ifBonusObject' => true, 'ifBuilding' => true],
    ],
  ],
  // XXX=B overlays warren/U, preventing on-click event
  'mushroomRings' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 18, 'TBDNHRD1', 'TOD',  'TR1HA', 0, 0, 5, 'TROGH'),
    ],
    'imageU' => [
      $dungeon => $image('HALLDUNG', 19, 'TBDNHRD2', 'TOD',  'TR2HA', 0, 0, 5, 'TROGH'),
    ],
    'ifU' => ['warrenU'],
    'town' => [$dungeon],
    'require' => ['fort', 'warren'],
    'cost_gold' => 1000,
    'name' => $spec[56][0],
    'description' => $spec[56][1],
    'descriptionU' => $spec[57][1],
    'effects' => [
      ['creature_growth', +7, true, 'ifCreature' => $troglodyte],
      ['creature_growth', +7, true, 'ifCreature' => $infernalTroglodyte],
    ],
  ],
  'warren' => [
    'id' => $id++,
    // XXX=IC warren/U border the screen edge and have outline partially cropped (not so in SoD)
    'image' => [
      $dungeon => $image('HALLDUNG', 30, 'TBDNDW_0', 'TOD',  'TRG1A', 0, 0, 4, 'TROG1'),
    ],
    'town' => [$dungeon],
    'require' => ['fort'],
    'cost_wood' => 10,
    'cost_gold' => 400,
    'produce' => [$troglodyte],
    'name' => $dwel[70][0],
    'description' => $dwel[70][1],
  ],
  'warrenU' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 37, 'TBDNUP_0', 'TOD',  'TRG2A', 0, 0, 4, 'TROG2'),
    ],
    'town' => [$dungeon],
    'upgrade' => ['warren'],
    'require' => ['warren', 'fort'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'produce' => [$troglodyte, $infernalTroglodyte],
    'name' => $dwel[77][0],
    'description' => $dwel[77][1],
  ],
  'harpyLoft' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 31, 'TBDNDW_1', 'TOD',  'HAR1', 0, 260, 0, 'HARP1'),
    ],
    'town' => [$dungeon],
    'require' => ['fort', 'warren'],
    'cost_gold' => 1000,
    'produce' => [$harpy],
    'name' => $dwel[71][0],
    'description' => $dwel[71][1],
  ],
  'harpyLoftU' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 38, 'TBDNUP_1', 'TOD',  'HAR2', 0, 260, 0, 'HARP2'),
    ],
    'town' => [$dungeon],
    'upgrade' => ['harpyLoft'],
    'require' => ['harpyLoft', 'fort', 'warren'],
    'cost_sulfur' => 2,
    'cost_crystal' => 2,
    'cost_gold' => 1000,
    'produce' => [$harpy, $harpyHag],
    'name' => $dwel[78][0],
    'description' => $dwel[78][1],
  ],
  'pillarOfEyes' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 32, 'TBDNDW_2', 'TOD',  'BEH1A', 118, 0, 2, 'BEH1'),
    ],
    'town' => [$dungeon],
    'require' => ['fort', 'warren'],
    'cost_wood' => 1,
    'cost_mercury' => 1,
    'cost_ore' => 1,
    'cost_sulfur' => 1,
    'cost_crystal' => 1,
    'cost_gems' => 1,
    'cost_gold' => 1000,
    'produce' => [$beholder],
    'name' => $dwel[72][0],
    'description' => $dwel[72][1],
  ],
  'pillarOfEyesU' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 39, 'TBDNUP_2', 'TOD',  'BEH2A', 118, 0, 2, 'BEH2'),
    ],
    'town' => [$dungeon],
    'upgrade' => ['pillarOfEyes'],
    'require' => ['pillarOfEyes', 'fort', 'warren'],
    'cost_wood' => 1,
    'cost_mercury' => 1,
    'cost_ore' => 1,
    'cost_sulfur' => 1,
    'cost_crystal' => 1,
    'cost_gems' => 1,
    'cost_gold' => 1000,
    'produce' => [$beholder, $evilEye],
    'name' => $dwel[79][0],
    'description' => $dwel[79][1],
  ],
  'chapelOfStilledVoices' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 33, 'TBDNDW_3', 'TOD',  'MED1', 300, 261, 0, 'MEDU1'),
    ],
    'town' => [$dungeon],
    'require' => ['fort', 'warren', 'harpyLoft', 'pillarOfEyes'],
    'cost_wood' => 5,
    'cost_ore' => 10,
    'cost_gold' => 2000,
    'produce' => [$medusa],
    'name' => $dwel[73][0],
    'description' => $dwel[73][1],
  ],
  'chapelOfStilledVoicesU' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 40, 'TBDNUP_3', 'TOD',  'MED2', 300, 261, 0, 'MEDU2'),
    ],
    'town' => [$dungeon],
    'upgrade' => ['chapelOfStilledVoices'],
    'require' => ['chapelOfStilledVoices', 'fort', 'warren', 'harpyLoft', 'pillarOfEyes'],
    'cost_wood' => 5,
    'cost_gold' => 1500,
    'produce' => [$medusa, $medusaQueen],
    'name' => $dwel[80][0],
    'description' => $dwel[80][1],
  ],
  'labyrinth' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 34, 'TBDNDW_4', 'TOD',  'MIN1', 551, 128, 0, 'MINO1'),
    ],
    'town' => [$dungeon],
    'require' => ['fort', 'warren', 'harpyLoft', 'pillarOfEyes', 'chapelOfStilledVoices'],
    'cost_ore' => 10,
    'cost_gems' => 10,
    'cost_gold' => 4000,
    'produce' => [$minotaur],
    'name' => $dwel[74][0],
    'description' => $dwel[74][1],
  ],
  'labyrinthU' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 41, 'TBDNUP_4', 'TOD',  'MIN2', 519, 128, 0, 'MINO2'),
    ],
    'town' => [$dungeon],
    'upgrade' => ['labyrinth'],
    'require' => ['labyrinth', 'fort', 'warren', 'harpyLoft', 'pillarOfEyes', 'chapelOfStilledVoices'],
    'cost_ore' => 5,
    'cost_gems' => 5,
    'cost_gold' => 3000,
    'produce' => [$minotaur, $minotaurKing],
    'name' => $dwel[81][0],
    'description' => $dwel[81][1],
  ],
  'manticoreLair' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 35, 'TBDNDW_5', 'TOD',  'MAN1', 270, 33, 0, 'MANT1'),
    ],
    'town' => [$dungeon],
    'require' => ['fort', 'warren', 'harpyLoft', 'pillarOfEyes', 'chapelOfStilledVoices'],
    'cost_wood' => 5,
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_sulfur' => 5,
    'cost_gold' => 5000,
    'produce' => [$manticore],
    'name' => $dwel[75][0],
    'description' => $dwel[75][1],
  ],
  'manticoreLairU' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 42, 'TBDNUP_5', 'TOD',  'MAN2', 270, 33, 0, 'MANT2'),
    ],
    'town' => [$dungeon],
    'upgrade' => ['manticoreLair'],
    'require' => ['manticoreLair', 'fort', 'warren', 'harpyLoft', 'pillarOfEyes', 'chapelOfStilledVoices'],
    'cost_wood' => 5,
    'cost_mercury' => 2,
    'cost_ore' => 5,
    'cost_sulfur' => 2,
    'cost_gold' => 3000,
    'produce' => [$manticore, $scorpicore],
    'name' => $dwel[82][0],
    'description' => $dwel[82][1],
  ],
  'dragonCave' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 36, 'TBDNDW_6', 'TOD',  'DRA1A', 550, 284, 0, 'DRAG1'),
    ],
    'town' => [$dungeon],
    'require' => ['mageGuild2', 'fort', 'warren', 'harpyLoft', 'pillarOfEyes', 'chapelOfStilledVoices', 'labyrinth', 'manticoreLair'],
    'cost_wood' => 15,
    'cost_ore' => 15,
    'cost_sulfur' => 20,
    'cost_gold' => 15000,
    'produce' => [$redDragon],
    'name' => $dwel[76][0],
    'description' => $dwel[76][1],
  ],
  'dragonCaveU' => [
    'id' => $id++,
    'image' => [
      $dungeon => $image('HALLDUNG', 43, 'TBDNUP_6', 'TOD',  'DRA2A', 550, 284, 0, 'DRAG2'),
    ],
    'town' => [$dungeon],
    'upgrade' => ['dragonCave'],
    'require' => ['dragonCave', 'mageGuild3', 'fort', 'warren', 'harpyLoft', 'pillarOfEyes', 'chapelOfStilledVoices', 'labyrinth', 'manticoreLair'],
    'cost_wood' => 15,
    'cost_ore' => 15,
    'cost_sulfur' => 20,
    'cost_gold' => 15000,
    'produce' => [$redDragon, $blackDragon],
    'name' => $dwel[83][0],
    'description' => $dwel[83][1],
  ],

  // Stronghold
  'hallOfValhalla' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 23, 'TBSTEXT2', 'TOS',  'VAH', 313, 179, 0, 'VAHAL'),
    ],
    'town' => [$stronghold],
    'require' => ['fort'],
    'cost_gold' => 1000,
    'name' => $spec[72][0],
    'description' => $spec[72][1],
    'effects' => [
      bonus_effects([[$append, ['hero_attack', +1, true]], 'ifBonusObject' => true, 'ifBuilding' => true]),
      ['bonus_message', [$const, [toMarkup($genr[585], '`<`{StatImage attack`} +1 Attack Skill`>')]], 'ifBonusObject' => true, 'ifBuilding' => true],
    ],
  ],
  'escapeTunnel' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 17, 'TBSTSPEC', 'TOS',  'CA1EA', 550, 103, 0, 'ESCAP'),
    ],
    'town' => [$stronghold],
    'require' => ['fort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'name' => $spec[66][0],
    'description' => $spec[66][1],
    'effects' => [
      ['retreatCan', true, true, 'ifGarrisoned' => true],
      ['retreatCan', true, true, 'ifVisiting' => true],
    ],
  ],
  // XXX=I
  'freelancerGuild' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 21, 'TBSTEXT0', 'TOS',  'MRK1C', 473, 30, 8),
      // XXX=I:dbst: $icon variant exists: BOSMRK2C
    ],
    'town' => [$stronghold],
    'require' => ['marketplace'],
    'cost_gold' => 10000,
    'name' => $spec[70][0],
    'description' => $spec[70][1],
  ],
  // XXX=I
  'ballistaYard' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 22, 'TBSTEXT1', 'TOS',  'BLK2', 617, 4, 6, 'BLAK2'),
    ],
    'town' => [$stronghold],
    'require' => ['blacksmith'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'name' => $spec[71][0],
    'description' => $spec[71][1],
  ],
  // XXX=B overlays goblinBarracks/U, preventing on-click event
  'messHall' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 18, 'TBSTHRD1', 'TOS',  'GOB1H', 373, 77, 2),
    ],
    'imageU' => [
      $stronghold => $image('HALLSTRN', 19, 'TBSTHRD2', 'TOS',  'GOB2H', 373, 76, 2),
    ],
    'ifU' => ['goblinBarracksU'],
    'town' => [$stronghold],
    'require' => ['fort', 'goblinBarracks'],
    'cost_gold' => 1000,
    'name' => $spec[67][0],
    'description' => $spec[67][1],
    'descriptionU' => $spec[68][1],
    'effects' => [
      ['creature_growth', +8, true, 'ifCreature' => $goblin],
      ['creature_growth', +8, true, 'ifCreature' => $hobgoblin],
    ],
  ],
  'goblinBarracks' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 30, 'TBSTDW_0', 'TOS',  'GOB1', 373, 77, 1),
    ],
    'town' => [$stronghold],
    'require' => ['fort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 200,
    'produce' => [$goblin],
    'name' => $dwel[84][0],
    'description' => $dwel[84][1],
  ],
  'goblinBarracksU' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 37, 'TBSTUP_0', 'TOS',  'GOB2', 373, 76, 1),
    ],
    'town' => [$stronghold],
    'upgrade' => ['goblinBarracks'],
    'require' => ['goblinBarracks', 'fort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$goblin, $hobgoblin],
    'name' => $dwel[91][0],
    'description' => $dwel[91][1],
  ],
  'wolfPen' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 31, 'TBSTDW_1', 'TOS',  'WOL1', 266, 64, 4, 'WOLF1'),
    ],
    'town' => [$stronghold],
    'require' => ['fort', 'goblinBarracks'],
    'cost_wood' => 10,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$wolfRider],
    'name' => $dwel[85][0],
    'description' => $dwel[85][1],
  ],
  'wolfPenU' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 38, 'TBSTUP_1', 'TOS',  'WOL2', 266, 65, 4, 'WOLF2'),
    ],
    'town' => [$stronghold],
    'upgrade' => ['wolfPen'],
    'require' => ['wolfPen', 'fort', 'goblinBarracksU'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$wolfRider, $wolfRaider],
    'name' => $dwel[92][0],
    'description' => $dwel[92][1],
  ],
  'orcTower' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 32, 'TBSTDW_2', 'TOS',  'ORC1', 566, 56, 4),
    ],
    'town' => [$stronghold],
    'require' => ['fort', 'goblinBarracks'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 1000,
    'produce' => [$orc],
    'name' => $dwel[86][0],
    'description' => $dwel[86][1],
  ],
  'orcTowerU' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 39, 'TBSTUP_2', 'TOS',  'ORC2', 566, 56, 4),
    ],
    'town' => [$stronghold],
    'upgrade' => ['orcTower'],
    'require' => ['orcTower', 'fort', 'blacksmith', 'goblinBarracks'],
    'cost_wood' => 2,
    'cost_ore' => 2,
    'cost_gold' => 1000,
    'produce' => [$orc, $orcChieftain],
    'name' => $dwel[93][0],
    'description' => $dwel[93][1],
  ],
  'ogreFort' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 33, 'TBSTDW_3', 'TOS',  'OGR1', 197, 100, 2, 'OGRE1'),
    ],
    'town' => [$stronghold],
    'require' => ['fort', 'goblinBarracks', 'orcTower'],
    'cost_wood' => 20,
    'cost_gold' => 2000,
    'produce' => [$ogre],
    'name' => $dwel[87][0],
    'description' => $dwel[87][1],
  ],
  'ogreFortU' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 40, 'TBSTUP_3', 'TOS',  'OGR2', 197, 99, 2, 'OGRE2'),
    ],
    'town' => [$stronghold],
    'upgrade' => ['ogreFort'],
    'require' => ['ogreFort', 'mageGuild1', 'fort', 'goblinBarracks', 'orcTower'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gems' => 5,
    'cost_gold' => 2000,
    'produce' => [$ogre, $ogreMage],
    'name' => $dwel[94][0],
    'description' => $dwel[94][1],
  ],
  'cliffNest' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 34, 'TBSTDW_4', 'TOS',  'ROC1', 137, 170, 0),
    ],
    'town' => [$stronghold],
    'require' => ['fort', 'goblinBarracks', 'wolfPen'],
    'cost_ore' => 10,
    'cost_gold' => 2500,
    'produce' => [$roc],
    'name' => $dwel[88][0],
    'description' => $dwel[88][1],
  ],
  'cliffNestU' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 41, 'TBSTUP_4', 'TOS',  'ROC2', 129, 169, 0),
    ],
    'town' => [$stronghold],
    'upgrade' => ['cliffNest'],
    'require' => ['cliffNest', 'fort', 'goblinBarracks', 'wolfPen'],
    'cost_ore' => 5,
    'cost_gems' => 5,
    'cost_gold' => 2000,
    'produce' => [$roc, $thunderbird],
    'name' => $dwel[95][0],
    'description' => $dwel[95][1],
  ],
  'cyclopCave' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 35, 'TBSTDW_5', 'TOS',  'CYC1', 622, 102, 0),
    ],
    'town' => [$stronghold],
    'require' => ['fort', 'goblinBarracks', 'orcTower', 'ogreFort'],
    'cost_ore' => 20,
    'cost_crystal' => 20,
    'cost_gold' => 3500,
    'produce' => [$cyclops],
    'name' => $dwel[89][0],
    'description' => $dwel[89][1],
  ],
  'cyclopCaveU' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 42, 'TBSTUP_5', 'TOS',  'CYC2A', 616, 101, 0, 'CYC2'),
    ],
    'town' => [$stronghold],
    'upgrade' => ['cyclopCave'],
    'require' => ['cyclopCave', 'fort', 'goblinBarracks', 'orcTower', 'ogreFort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 3000,
    'produce' => [$cyclops, $cyclopsKing],
    'name' => $dwel[96][0],
    'description' => $dwel[96][1],
  ],
  'behemothLair' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 36, 'TBSTDW_6', 'TOS',  'BEH1A', 604, 196, 0, 'BEH1'),
    ],
    'town' => [$stronghold],
    'require' => ['fort', 'goblinBarracks', 'wolfPen', 'cliffNest'],
    'cost_wood' => 10,
    'cost_ore' => 10,
    'cost_crystal' => 10,
    'cost_gold' => 10000,
    'produce' => [$behemoth],
    'name' => $dwel[90][0],
    'description' => $dwel[90][1],
  ],
  'behemothLairU' => [
    'id' => $id++,
    'image' => [
      $stronghold => $image('HALLSTRN', 43, 'TBSTUP_6', 'TOS',  'BEH2A', 604, 196, 0, 'BEH2'),
    ],
    'town' => [$stronghold],
    'upgrade' => ['behemothLair'],
    'require' => ['behemothLair', 'fort', 'goblinBarracks', 'wolfPen', 'cliffNest'],
    'cost_wood' => 10,
    'cost_ore' => 10,
    'cost_crystal' => 20,
    'cost_gold' => 15000,
    'produce' => [$behemoth, $ancientBehemoth],
    'name' => $dwel[97][0],
    'description' => $dwel[97][1],
  ],

  // Fortress
  'cageOfWarlords' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 17, 'TBFRSPEC', 'TOF',  'CAGE', 703, 278, 1),
    ],
    'town' => [$fortress],
    'require' => ['tavern', 'fort', 'townHall', 'glyphsOfFear'],
    'cost_gold' => 1000,
    'name' => $spec[77][0],
    'description' => $spec[77][1],
    'effects' => [
      bonus_effects([[$append, ['hero_defense', +1, true]], 'ifBonusObject' => true, 'ifBuilding' => true]),
      ['bonus_message', [$const, [toMarkup($genr[586], '`<`{StatImage defense`} +1 Defense Skill`>')]], 'ifBonusObject' => true, 'ifBuilding' => true],
    ],
  ],
  'glyphsOfFear' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 21, 'TBFREXT0', 'TOF',  'CASD', 341, 87, 4, 'CASTD'),
    ],
    'town' => [$fortress],
    'require' => ['fort'],
    'cost_gold' => 1000,
    'name' => $spec[81][0],
    'description' => $spec[81][1],
    'effects' => [
      ['hero_defense', +2, true, 'ifContext' => $combat],
      ['hero_defense', +2, 'ifContext' => $combat, 'ifGarrisoned' => true],
      ['hero_defense', +2, 'ifContext' => $combat, 'ifVisiting' => true],
    ],
  ],
  'bloodObelisk' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 22, 'TBFREXT1', 'TOF',  'CASA', 349, 169, 0, 'CASTA'),
    ],
    'town' => [$fortress],
    'require' => ['glyphsOfFear'],
    'cost_gold' => 1000,
    'name' => $spec[82][0],
    'description' => $spec[82][1],
    'effects' => [
      ['hero_attack', +2, true, 'ifContext' => $combat],
      ['hero_attack', +2, 'ifContext' => $combat, 'ifGarrisoned' => true],
      ['hero_attack', +2, 'ifContext' => $combat, 'ifVisiting' => true],
    ],
  ],
  // XXX=B overlays gnollHut/U, preventing on-click event
  'captainQuarters' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 18, 'TBFRHRD1', 'TOF',  'GNL1H', 641, 106, 8, 'GNO1H'),
    ],
    'imageU' => [
      $fortress => $image('HALLFORT', 19, 'TBFRHRD2', 'TOF',  'GNL2H', 641, 106, 8, 'GNO2H'),
    ],
    'ifU' => ['gnollHutU'],
    'town' => [$fortress],
    'require' => ['fort', 'gnollHut'],
    'cost_gold' => 1000,
    'name' => $spec[78][0],
    'description' => $spec[78][1],
    'descriptionU' => $spec[79][1],
    'effects' => [
      ['creature_growth', +6, true, 'ifCreature' => $gnoll],
      ['creature_growth', +6, true, 'ifCreature' => $gnollMarauder],
    ],
  ],
  'gnollHut' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 30, 'TBFRDW_0', 'TOF',  'GNL1', 641, 106, 6, 'GNOL1'),
    ],
    'town' => [$fortress],
    'require' => ['fort'],
    'cost_wood' => 10,
    'cost_gold' => 400,
    'produce' => [$gnoll],
    'name' => $dwel[98][0],
    'description' => $dwel[98][1],
  ],
  'gnollHutU' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 37, 'TBFRUP_0', 'TOF',  'GNL2', 641, 106, 6, 'GNOL2'),
    ],
    'town' => [$fortress],
    'upgrade' => ['gnollHut'],
    'require' => ['gnollHut', 'tavern', 'fort'],
    'cost_wood' => 10,
    'cost_gold' => 1000,
    'produce' => [$gnoll, $gnollMarauder],
    'name' => $dwel[105][0],
    'description' => $dwel[105][1],
  ],
  'lizardDen' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 31, 'TBFRDW_1', 'TOF',  'LIZ1', 141, 98, 2, 'LIZR1'),
    ],
    'town' => [$fortress],
    'require' => ['fort', 'gnollHut'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'produce' => [$lizardman],
    'name' => $dwel[99][0],
    'description' => $dwel[99][1],
  ],
  'lizardDenU' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 38, 'TBFRUP_1', 'TOF',  'LIZ2', 125, 86, 2, 'LIZR2'),
    ],
    'town' => [$fortress],
    'upgrade' => ['lizardDen'],
    'require' => ['lizardDen', 'fort', 'gnollHut'],
    'cost_wood' => 5,
    'cost_gold' => 1000,
    'produce' => [$lizardman, $lizardWarrior],
    'name' => $dwel[106][0],
    'description' => $dwel[106][1],
  ],
  'serpentFlyHive' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 32, 'TBFRDW_3', 'TOF',  'FLY1A', 192, 237, 0, 'FLY1'),
    ],
    'town' => [$fortress],
    'require' => ['fort', 'gnollHut'],
    'cost_wood' => 5,
    'cost_mercury' => 2,
    'cost_sulfur' => 2,
    'cost_gold' => 1000,
    'produce' => [$serpentFly],
    'name' => $dwel[100][0],
    'description' => $dwel[100][1],
  ],
  'serpentFlyHiveU' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 39, 'TBFRUP_3', 'TOF',  'FLY2A', 159, 221, 0, 'FLY2'),
    ],
    'town' => [$fortress],
    'upgrade' => ['serpentFlyHive'],
    'require' => ['serpentFlyHive', 'fort', 'gnollHut'],
    'cost_mercury' => 2,
    'cost_sulfur' => 2,
    'cost_gold' => 1000,
    'produce' => [$serpentFly, $dragonFly],
    'name' => $dwel[107][0],
    'description' => $dwel[107][1],
  ],
  'basiliskPit' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 33, 'TBFRDW_4', 'TOF',  'BAS1', 0, 1, 10),
    ],
    'town' => [$fortress],
    'require' => ['fort', 'gnollHut', 'serpentFlyHive'],
    'cost_wood' => 5,
    'cost_ore' => 10,
    'cost_gold' => 2000,
    'produce' => [$basilisk],
    'name' => $dwel[101][0],
    'description' => $dwel[101][1],
  ],
  'basiliskPitU' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 40, 'TBFRUP_4', 'TOF',  'BAS2', 0, 1, 10),
    ],
    'town' => [$fortress],
    'upgrade' => ['basiliskPit'],
    'require' => ['basiliskPit', 'fort', 'gnollHut', 'serpentFlyHive'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$basilisk, $greaterBasilisk],
    'name' => $dwel[108][0],
    'description' => $dwel[108][1],
  ],
  'gorgonLair' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 34, 'TBFRDW_2', 'TOF',  'GOR1', 15, 142, 0, 'GORG1'),
    ],
    'town' => [$fortress],
    'require' => ['fort', 'gnollHut', 'lizardDen', 'serpentFlyHive'],
    'cost_wood' => 10,
    'cost_mercury' => 5,
    'cost_ore' => 10,
    'cost_sulfur' => 5,
    'cost_gold' => 2500,
    'produce' => [$gorgon],
    'name' => $dwel[102][0],
    'description' => $dwel[102][1],
  ],
  'gorgonLairU' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 41, 'TBFRUP_2', 'TOF',  'GOR2', 15, 142, 0, 'GORG2'),
    ],
    'town' => [$fortress],
    'upgrade' => ['gorgonLair'],
    'require' => ['gorgonLair', 'fort', 'marketplace', 'resourceSiloWO', 'gnollHut', 'lizardDen', 'serpentFlyHive'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$gorgon, $mightyGorgon],
    'name' => $dwel[109][0],
    'description' => $dwel[109][1],
  ],
  'wyvernNest' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 35, 'TBFRDW_5', 'TOF',  'WYV1', 0, 262, 0, 'WYVR1'),
    ],
    'town' => [$fortress],
    'require' => ['fort', 'gnollHut', 'lizardDen'],
    'cost_wood' => 15,
    'cost_gold' => 3500,
    'produce' => [$wyvern],
    'name' => $dwel[103][0],
    'description' => $dwel[103][1],
  ],
  'wyvernNestU' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 42, 'TBFRUP_5', 'TOF',  'WYV2', 0, 252, 0, 'WYVR2'),
    ],
    'town' => [$fortress],
    'upgrade' => ['wyvernNest'],
    'require' => ['wyvernNest', 'fort', 'gnollHut', 'lizardDen'],
    'cost_wood' => 10,
    'cost_mercury' => 10,
    'cost_gold' => 3000,
    'produce' => [$wyvern, $wyvernMonarch],
    'name' => $dwel[110][0],
    'description' => $dwel[110][1],
  ],
  'hydraPond' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 36, 'TBFRDW_6', 'TOF',  'HYD1A', 612, 0, 14, 'HYDR1'),
    ],
    'town' => [$fortress],
    'require' => ['fort', 'gnollHut', 'lizardDen', 'serpentFlyHive', 'basiliskPit', 'wyvernNest'],
    'cost_wood' => 10,
    'cost_ore' => 10,
    'cost_sulfur' => 10,
    'cost_gold' => 10000,
    'produce' => [$hydra],
    'name' => $dwel[104][0],
    'description' => $dwel[104][1],
  ],
  'hydraPondU' => [
    'id' => $id++,
    'image' => [
      $fortress => $image('HALLFORT', 43, 'TBFRUP_6', 'TOF',  'HYD2A', 587, 0, 14, 'HYDR2'),
    ],
    'town' => [$fortress],
    'upgrade' => ['hydraPond'],
    'require' => ['hydraPond', 'fort', 'gnollHut', 'lizardDen', 'serpentFlyHive', 'basiliskPit', 'wyvernNest'],
    'cost_wood' => 10,
    'cost_ore' => 10,
    'cost_sulfur' => 20,
    'cost_gold' => 15000,
    'produce' => [$hydra, $chaosHydra],
    'name' => $dwel[111][0],
    'description' => $dwel[111][1],
  ],

  // Conflux
  //
  // XXX=I
  'magicUniversity' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 21, 'TBELEXT6', 'TOEL',  'EXT6', 104, 85, 10, 'UNIV'),
    ],
    'town' => [$conflux],
    'require' => ['mageGuild1'],
    'cost_wood' => 10,
    'cost_ore' => 10,
    'cost_gold' => 1000,
    'name' => $spec[92][0],
    'description' => $spec[92][1],
  ],
  // XXX=B overlays magicLantern/U, preventing on-click event
  'gardenOfLife' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 18, 'TBELHRD1', 'TOEL',  'HRD1', 689, 0, 4),
    ],
    'imageU' => [
      $conflux => $image('HALLELEM', 19, 'TBELHRD2', 'TOEL',  'HRD2', 689, 0, 4),
    ],
    'ifU' => ['magicLanternU'],
    'town' => [$conflux],
    'require' => ['fort', 'magicLantern'],
    'cost_gold' => 1000,
    'name' => $spec[89][0],
    'description' => $spec[89][1],
    'descriptionU' => $spec[90][1],
    'effects' => [
      ['creature_growth', +10, true, 'ifCreature' => $pixie],
      ['creature_growth', +10, true, 'ifCreature' => $sprite],
    ],
  ],
  'magicLantern' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 30, 'TBELDW_0', 'TOEL',  'DW_0', 689, 0, 4, 'DN_0'),
    ],
    'town' => [$conflux],
    'require' => ['fort'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 300,
    'produce' => [$pixie],
    'name' => $dwel[112][0],
    'description' => $dwel[112][1],
  ],
  'magicLanternU' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 37, 'TBELUP_0', 'TOEL',  'UP_0', 689, 0, 4),
    ],
    'town' => [$conflux],
    'upgrade' => ['magicLantern'],
    'require' => ['magicLantern', 'fort'],
    'cost_gold' => 1000,
    'produce' => [$pixie, $sprite],
    'name' => $dwel[119][0],
    'description' => $dwel[119][1],
  ],
  'altarOfAir' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 31, 'TBELDW_1', 'TOEL',  'DW_1', 630, 254, 0, 'DN_1'),
    ],
    'town' => [$conflux],
    'require' => ['mageGuild1', 'fort', 'magicLantern'],
    'cost_ore' => 5,
    'cost_gold' => 1500,
    'produce' => [$airElemental],
    'name' => $dwel[113][0],
    'description' => $dwel[113][1],
  ],
  'altarOfAirU' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 38, 'TBELUP_1', 'TOEL',  'UP_1', 630, 254, 0),
    ],
    'town' => [$conflux],
    'upgrade' => ['altarOfAir'],
    'require' => ['altarOfAir', 'mageGuild1', 'fort', 'magicLantern'],
    'cost_wood' => 2,
    'cost_mercury' => 2,
    'cost_gems' => 2,
    'cost_gold' => 1500,
    'produce' => [$airElemental, $stormElemental],
    'name' => $dwel[120][0],
    'description' => $dwel[120][1],
  ],
  'altarOfWater' => [
    'id' => $id++,
    'image' => [
      // In SoD altarOfWater/U wrongly overlay TBELEXT3 (anim4).
      $conflux => $image('HALLELEM', 32, 'TBELDW_2', 'TOEL',  'DW_2', 709, 126, 0, 'DN_2'),
    ],
    'town' => [$conflux],
    'require' => ['mageGuild1', 'fort', 'magicLantern'],
    'cost_ore' => 5,
    'cost_gold' => 1500,
    'produce' => [$waterElemental],
    'name' => $dwel[114][0],
    'description' => $dwel[114][1],
  ],
  'altarOfWaterU' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 39, 'TBELUP_2', 'TOEL',  'UP_2', 709, 126, 0),
    ],
    'town' => [$conflux],
    'upgrade' => ['altarOfWater'],
    'require' => ['altarOfWater', 'mageGuild1', 'fort', 'magicLantern'],
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$waterElemental, $iceElemental],
    'name' => $dwel[121][0],
    'description' => $dwel[121][1],
  ],
  'altarOfFire' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 33, 'TBELDW_3', 'TOEL',  'DW_3', 108, 164, 6, 'DN_3'),
    ],
    'town' => [$conflux],
    'require' => ['mageGuild1', 'fort', 'magicLantern', 'altarOfAir'],
    'cost_wood' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$fireElemental],
    'name' => $dwel[115][0],
    'description' => $dwel[115][1],
  ],
  'altarOfFireU' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 40, 'TBELUP_3', 'TOEL',  'UP_3', 108, 164, 6),
    ],
    'town' => [$conflux],
    'upgrade' => ['altarOfFire'],
    'require' => ['altarOfFire', 'mageGuild1', 'fort', 'magicLantern', 'altarOfAirU'],
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_gold' => 2000,
    'produce' => [$fireElemental, $energyElemental],
    'name' => $dwel[122][0],
    'description' => $dwel[122][1],
  ],
  'altarOfEarth' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 34, 'TBELDW_4', 'TOEL',  'DW_4', 264, 161, 0, 'DN_4'),
    ],
    'town' => [$conflux],
    'require' => ['mageGuild1', 'fort', 'magicLantern', 'altarOfWater'],
    'cost_ore' => 10,
    'cost_gold' => 2000,
    'produce' => [$earthElemental],
    'name' => $dwel[116][0],
    'description' => $dwel[116][1],
  ],
  'altarOfEarthU' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 41, 'TBELUP_4', 'TOEL',  'UP_4', 264, 161, 0),
    ],
    'town' => [$conflux],
    'upgrade' => ['altarOfEarth'],
    'require' => ['altarOfEarth', 'mageGuild1', 'fort', 'magicLantern', 'altarOfWater'],
    'cost_sulfur' => 5,
    'cost_gold' => 1000,
    'produce' => [$earthElemental, $magmaElemental],
    'name' => $dwel[123][0],
    'description' => $dwel[123][1],
  ],
  'altarOfThought' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 35, 'TBELDW_5', 'TOEL',  'DW_5', 394, 3, 18, 'DN_5'),
    ],
    'town' => [$conflux],
    'require' => ['mageGuild1', 'fort', 'magicLantern', 'altarOfAir', 'altarOfWater', 'altarOfFire', 'altarOfEarth'],
    'cost_wood' => 5,
    'cost_mercury' => 5,
    'cost_ore' => 5,
    'cost_sulfur' => 5,
    'cost_crystal' => 5,
    'cost_gems' => 3000,
    'produce' => [$psychicElemental],
    'name' => $dwel[117][0],
    'description' => $dwel[117][1],
  ],
  'altarOfThoughtU' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 42, 'TBELUP_5', 'TOEL',  'UP_5', 394, 3, 18),
    ],
    'town' => [$conflux],
    'upgrade' => ['altarOfThought'],
    'require' => ['altarOfThought', 'mageGuild2', 'fort', 'magicLantern', 'altarOfAir', 'altarOfWater', 'altarOfFire', 'altarOfEarth'],
    'cost_mercury' => 3,
    'cost_sulfur' => 3,
    'cost_crystal' => 3,
    'cost_gems' => 3,
    'cost_gold' => 3000,
    'produce' => [$psychicElemental, $magicElemental],
    'name' => $dwel[124][0],
    'description' => $dwel[124][1],
  ],
  'pyre' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 36, 'TBELDW_6', 'TOEL',  'DW_6', 34, 232, 0, 'DN_6'),
    ],
    'town' => [$conflux],
    'require' => ['mageGuild1', 'fort', 'magicLantern', 'altarOfAir', 'altarOfWater', 'altarOfFire', 'altarOfEarth', 'altarOfThought'],
    'cost_wood' => 10,
    'cost_mercury' => 10,
    'cost_ore' => 10,
    'cost_gold' => 10000,
    'produce' => [$firebird],
    'name' => $dwel[118][0],
    'description' => $dwel[118][1],
  ],
  'pyreU' => [
    'id' => $id++,
    'image' => [
      $conflux => $image('HALLELEM', 43, 'TBELUP_6', 'TOEL',  'UP_6', 43, 232, 0),
    ],
    'town' => [$conflux],
    'upgrade' => ['pyre'],
    'require' => ['pyre', 'mageGuild1', 'fort', 'magicLantern', 'altarOfAir', 'altarOfWater', 'altarOfFire', 'altarOfEarth', 'altarOfThought'],
    'cost_wood' => 10,
    'cost_mercury' => 20,
    'cost_ore' => 20,
    'cost_gold' => 15000,
    'produce' => [$firebird, $phoenix],
    'name' => $dwel[125][0],
    'description' => $dwel[125][1],
  ],
];